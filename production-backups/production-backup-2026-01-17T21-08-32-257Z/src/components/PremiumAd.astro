---
interface Props {
  slot?: 'hero-sidebar' | 'article-top' | 'article-middle' | 'article-bottom' | 'category-sidebar';
  size?: '300x250' | '336x280' | '728x90' | '320x50' | '300x600';
  priority?: 'high' | 'medium' | 'low';
  targeting?: string[];
  className?: string;
}

const { 
  slot = 'hero-sidebar',
  size = '300x250',
  priority = 'high',
  targeting = ['ai-tools', 'saas', 'productivity'],
  className = ''
} = Astro.props;

// Ad configuration based on slot
const adConfigs = {
  'hero-sidebar': {
    title: 'Premium AI Tools',
    description: 'Discover cutting-edge AI solutions',
    cpm: '$15-25',
    size: '300x250'
  },
  'article-top': {
    title: 'Featured AI Software',
    description: 'Top-rated tools for professionals',
    cpm: '$12-20',
    size: '728x90'
  },
  'article-middle': {
    title: 'AI Productivity Suite',
    description: 'Boost your workflow efficiency',
    cpm: '$10-18',
    size: '300x250'
  },
  'article-bottom': {
    title: 'Latest AI Innovations',
    description: 'Stay ahead with new releases',
    cpm: '$8-15',
    size: '336x280'
  },
  'category-sidebar': {
    title: 'Category Partners',
    description: 'Related AI solutions',
    cmp: '$6-12',
    size: '300x250'
  }
};

const config = adConfigs[slot];
const adId = `ad-${slot}-${Math.random().toString(36).substr(2, 9)}`;

// Premium targeting keywords for high-CPM ads
const targetingString = targeting.join(',');
---

<div class={`premium-ad-container ${className}`} data-ad-slot={slot} data-size={size} id={adId}>
  <div class="ad-label">
    <span class="partner-text">Partner Content</span>
  </div>
  
  <div class="ad-content" data-targeting={targetingString}>
    <!-- HIGH-CPM AI TOOL AD PLACEHOLDER -->
    <div class="premium-ad-placeholder">
      <div class="ad-visual">
        <div class="ai-icon">ðŸ¤–</div>
        <div class="ad-badge">PREMIUM</div>
      </div>
      <div class="ad-text">
        <h4>{config.title}</h4>
        <p>{config.description}</p>
        <button class="ad-cta">Explore Tools â†’</button>
      </div>
    </div>
    
    <!-- REAL AD INTEGRATION SCRIPTS (hardened, client-only) -->
    <script define:vars={{ adId, targetingString, size, priority }} is:inline>
      (function () {
        // Guard against SSR and missing DOM
        if (typeof window === 'undefined' || typeof document === 'undefined') return;
        const adContainer = document.getElementById(adId);
        if (!adContainer) return;

        // Avoid duplicate initialization
        if (adContainer.getAttribute('data-ad-initialized') === 'true') return;

        // Ensure adsbygoogle is available before proceeding
        if (!('adsbygoogle' in window)) {
          // Defer retry to next tick to allow AdSense script to load
          setTimeout(() => {
            const evt = new Event('adsbygoogle:tryInit');
            window.dispatchEvent(evt);
          }, 0);
          return;
        }

        try {
          // Create ad unit
          const adSlot = document.createElement('ins');
          adSlot.className = 'adsbygoogle';
          adSlot.style.display = 'block';
          adSlot.setAttribute('data-ad-client', 'ca-pub-YOUR-ADSENSE-ID');
          adSlot.setAttribute('data-ad-slot', 'YOUR-AD-UNIT-ID');
          adSlot.setAttribute('data-ad-format', 'rectangle');
          adSlot.setAttribute('data-full-width-responsive', 'false');

          // Premium targeting
          if (targetingString) {
            adSlot.setAttribute('data-ad-targeting', targetingString);
          }

          // Size-specific configuration (keep minimal and explicit)
          if (size === '300x250') {
            adSlot.style.width = '300px';
            adSlot.style.height = '250px';
          }

          // Priority flag
          if (priority === 'high') {
            adSlot.setAttribute('data-ad-priority', 'high');
          }

          // Replace placeholder only if it still exists and container is attached
          const placeholder = adContainer.querySelector('.premium-ad-placeholder');
          if (placeholder && document.body.contains(adContainer)) {
            adContainer.replaceChild(adSlot, placeholder);
            adContainer.setAttribute('data-ad-initialized', 'true');
            (window.adsbygoogle as any).push({});
          }
        } catch (e) {
          // Fail safely without breaking layout
          console.warn('PremiumAd: Ad initialization failed gracefully:', e);
        }
      })();

      // Optional: listen for deferred init signal if AdSense loads slightly later
      window.addEventListener && window.addEventListener('adsbygoogle:tryInit', () => {
        // Re-run only if not initialized yet
        try {
          const container = document.getElementById(adId);
          if (!container || container.getAttribute('data-ad-initialized') === 'true') return;
          if (!('adsbygoogle' in window)) return;

          const adSlot = document.createElement('ins');
          adSlot.className = 'adsbygoogle';
          adSlot.style.display = 'block';
          adSlot.setAttribute('data-ad-client', 'ca-pub-YOUR-ADSENSE-ID');
          adSlot.setAttribute('data-ad-slot', 'YOUR-AD-UNIT-ID');
          adSlot.setAttribute('data-ad-format', 'rectangle');
          adSlot.setAttribute('data-full-width-responsive', 'false');

          if (targetingString) adSlot.setAttribute('data-ad-targeting', targetingString);
          if (size === '300x250') {
            adSlot.style.width = '300px';
            adSlot.style.height = '250px';
          }
          if (priority === 'high') adSlot.setAttribute('data-ad-priority', 'high');

          const placeholder = container.querySelector('.premium-ad-placeholder');
          if (placeholder && document.body.contains(container)) {
            container.replaceChild(adSlot, placeholder);
            container.setAttribute('data-ad-initialized', 'true');
            (window.adsbygoogle as any).push({});
          }
        } catch (e) {
          console.warn('PremiumAd: Deferred init failed gracefully:', e);
        }
      });
    </script>
  </div>
  
  <div class="ad-analytics" style="display: none;">
    <!-- Revenue tracking -->
    <script define:vars={{ slot, size, targetingString, config }}>
      // Track ad performance
      if (typeof gtag !== 'undefined') {
        gtag('event', 'ad_impression', {
          'ad_slot': slot,
          'ad_size': size,
          'targeting': targetingString,
          'estimated_cpm': config.cpm || config.cmp
        });
      }
    </script>
  </div>
</div>

<style>
  .premium-ad-container {
    background: rgba(26, 26, 27, 0.95);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 12px;
    overflow: hidden;
    position: relative;
    margin-bottom: 1.5rem;
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
  }
  
  .premium-ad-container:hover {
    border-color: rgba(0, 212, 255, 0.4);
    box-shadow: 0 8px 25px rgba(0, 212, 255, 0.15);
    transform: translateY(-2px);
  }
  
  .ad-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem 1rem;
    background: rgba(0, 212, 255, 0.1);
    border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    font-size: 0.75rem;
    color: #b3b3b3;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .ad-metrics {
    font-size: 0.85rem;
    cursor: help;
  }
  
  .ad-content {
    padding: 1.2rem;
    min-height: 250px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  /* Premium Ad Placeholder Styling */
  .premium-promo-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    gap: 1rem;
  }
  
  .ad-visual {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }
  
  .ai-icon {
    font-size: 3rem;
    background: linear-gradient(135deg, #00d4ff 0%, #0066ff 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    filter: drop-shadow(0 2px 8px rgba(0, 212, 255, 0.3));
  }
  
  .ad-badge {
    background: linear-gradient(135deg, #ff6b00 0%, #ff0066 100%);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.5px;
    box-shadow: 0 2px 10px rgba(255, 102, 0, 0.3);
  }
  
  .ad-text h4 {
    color: #ffffff;
    font-size: 1.1rem;
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    background: linear-gradient(135deg, #ffffff 0%, #00d4ff 100%);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  
  .ad-text p {
    color: #b3b3b3;
    font-size: 0.9rem;
    margin: 0 0 1rem 0;
    line-height: 1.4;
  }
  
  .ad-cta {
    background: linear-gradient(135deg, #00d4ff 0%, #0066ff 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
  }
  
  .ad-cta:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 212, 255, 0.4);
    background: linear-gradient(135deg, #00e5ff 0%, #0077ff 100%);
  }
  
  /* Responsive sizing */
  @media (max-width: 768px) {
    .premium-ad-container {
      margin-bottom: 1rem;
    }
    
    .ad-content {
      padding: 1rem;
      min-height: 200px;
    }
    
    .ai-icon {
      font-size: 2.5rem;
    }
    
    .ad-text h4 {
      font-size: 1rem;
    }
    
    .ad-text p {
      font-size: 0.85rem;
    }
    
    .ad-cta {
      padding: 0.6rem 1.2rem;
      font-size: 0.85rem;
    }
  }
  
  /* High-performance animations */
  .premium-ad-container,
  .ad-cta {
    will-change: transform;
    transform: translateZ(0);
  }
  
  /* Dark theme integration */
  @media (prefers-color-scheme: dark) {
    .premium-ad-container {
      background: rgba(26, 26, 27, 0.98);
    }
  }
</style>
