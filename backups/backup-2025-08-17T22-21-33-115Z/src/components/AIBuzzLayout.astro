---
import { getArticlesByCategory } from '../lib/sanity';
import { generateWebPUrl, generateResponsiveSrcSet, generateThumbnail } from '../utils/imageOptimization'
import CategorySidebar from './CategorySidebar.astro';
import BaseHead from './BaseHead.astro';
import Header from './Header.astro';
import Footer from './Footer.astro';
import { getCategoryUrl } from '../utils/urlHelpers';
import { HOMEPAGE_CATEGORIES } from '../consts.ts';

// Type for homepage categories
interface HomepageCategory {
	slug: string;
	displayName: string;
}

const homepageCategories: HomepageCategory[] = HOMEPAGE_CATEGORIES as HomepageCategory[];

// Helper functions
function getArticleUrl(article: any) {
	const category = article.category?.slug?.current || 'marketing';
	const slug = article.slug?.current || article.slug;
	return `/${category}/${slug}`;
}

function formatDate(dateString: string) {
	return new Date(dateString).toLocaleDateString('en-US', { 
		month: 'short', 
		day: 'numeric' 
	})
}

// Helper to flatten Portable Text array to plain text
function portableTextToPlainText(content: any[]): string {
	if (!Array.isArray(content)) return '';
	return content
		.map((block: any) => {
			if (block._type === 'block' && Array.isArray(block.children)) {
				return block.children.map((child: any) => child.text).join(' ');
			}
			// Handle custom HTML blocks
			if (block._type === 'htmlBlock' && typeof block.html === 'string') {
				// Strip HTML tags and return text
				return block.html.replace(/<[^>]*>/g, ' ');
			}
			return '';
		})
		.join(' ');
}

// Helper: Unified magazine card renderer
interface MagazineCardProps {
	article: any;
	category: string;
	displayName: string;
	badge?: string;
	minimal?: boolean;
}

// Fetch articles for each homepage category
const categoryArticles: Record<string, any[]> = {};
for (const category of homepageCategories) {
	categoryArticles[category.slug] = await getArticlesByCategory(category.slug);
}

// Fallback data if no articles are found
const fallbacks = [
	{ data: { title: "Sample AI News Article", excerpt: "This is a sample article for demonstration.", category: "ai-news", author: "AI Expert", publishedAt: new Date().toISOString() }, slug: "sample-1" },
	{ data: { title: "Another AI Update", excerpt: "Another sample article for the grid.", category: "ai-news", author: "Tech Writer", publishedAt: new Date().toISOString() }, slug: "sample-2" },
	{ data: { title: "AI Technology Review", excerpt: "Review of latest AI technology.", category: "ai-news", author: "Reviewer", publishedAt: new Date().toISOString() }, slug: "sample-3" },
	{ data: { title: "Industry Analysis", excerpt: "Deep dive into AI industry trends.", category: "ai-news", author: "Analyst", publishedAt: new Date().toISOString() }, slug: "sample-4" },
	{ data: { title: "Tutorial Guide", excerpt: "How to implement AI solutions.", category: "ai-news", author: "Instructor", publishedAt: new Date().toISOString() }, slug: "sample-5" },
	{ data: { title: "Latest Updates", excerpt: "Recent developments in AI field.", category: "ai-news", author: "Reporter", publishedAt: new Date().toISOString() }, slug: "sample-6" },
	{ data: { title: "AI Agent Development Guide", excerpt: "Learn how to build and deploy intelligent AI agents for automation.", category: "ai-agents", author: "AI Developer", publishedAt: new Date().toISOString() }, slug: "ai-agent-guide" },
	{ data: { title: "Enterprise AI Agents", excerpt: "How businesses are leveraging AI agents to streamline operations.", category: "ai-agents", author: "Business Analyst", publishedAt: new Date().toISOString() }, slug: "enterprise-ai-agents" }
]

// Use fallback data if no articles are found
const finalArticles: Record<string, any[]> = {};
for (const category in categoryArticles) {
	finalArticles[category] = categoryArticles[category].length > 0 ? categoryArticles[category] : fallbacks.slice(0, 8);
}

// Get main articles for each section (4 articles each, except reviews which has 6 large cards)
const mainArticles: Record<string, any[]> = {};
for (const category in finalArticles) {
	mainArticles[category] = finalArticles[category].slice(0, 4);
}

// No explicit sidebar slicing needed here, CategorySidebar handles it.

// Debug logging
// console.log('üîç Debug: Article counts for homepage sections');
// for (const category in mainArticles) {
// 	console.log(`${category} - Main: ${mainArticles[category].length}, Sidebar: ${sidebarArticles[category].length}`);
// }

// Log first few articles to check for duplicates
// for (const category in mainArticles) {
// 	console.log(`üîç Debug: First 2 main ${category} articles:`, mainArticles[category].slice(0, 2).map((a: any) => a.title));
// 	console.log(`üîç Debug: First 2 sidebar ${category} articles:`, sidebarArticles[category].slice(0, 2).map((a: any) => a.title));
// }

// Debug author data structure
// for (const category in mainArticles) {
// 	if (mainArticles[category].length > 0 && mainArticles[category][0].author) {
// 		console.log(`üîç Debug: Author data structure for ${category}:`, JSON.stringify(mainArticles[category][0].author, null, 2));
// 	}
// }
---

<section class="aibuzz-layout">
	<div class="layout-container">
		{homepageCategories.map((cat: HomepageCategory) => {
			const allCategoryArticles = categoryArticles[cat.slug] || [];
			const mainArticles = allCategoryArticles.slice(0, 4);
			// CategorySidebar will handle its own slicing from allCategoryArticles

			// MARKETING SECTION: Use Business section layout and markup
			if (cat.slug === 'marketing') {
				return (
					<section class="content-section" id={cat.slug}>
						<div class="section-header">
							<h2 class="section-title"><a href={`/categories/${cat.slug}`}>{cat.displayName}</a></h2>
							<a href={`/categories/${cat.slug}`} class="view-all-link">View All ‚Üí</a>
						</div>
						<div class="section-layout marketing-section-layout">
							<div class="main-content">
								<div class="grid-layout-special">
									<div class="top-row">
										{mainArticles.slice(0, 2).map((article: any) => (
											<article class="large-card">
												<a href={getArticleUrl(article)} class="card-image-link">
													<div class="card-image" style="aspect-ratio: 16/9; height: 250px;">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" style="object-fit: cover; width: 100%; height: 100%;" />
														) : (
															<div class="placeholder-image">üì∞</div>
														)}
														<div class="card-image-gradient" style="position:absolute;left:0;bottom:0;width:100%;height:40%;background:linear-gradient(180deg,rgba(24,25,26,0) 0%,rgba(24,25,26,0.7) 100%);"></div>
													</div>
												</a>
												<div class="card-content">
													<a href={`/categories/${cat.slug}`} class="category-tag category-link-safe">{cat.displayName}</a>
													<div style="height: 16px;"></div>
													<h3 style="font-weight:800;"><a href={getArticleUrl(article)}>{article.title}</a></h3>
													<p>{article.excerpt}</p>
													<div class="card-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
									<div class="business-bottom-row">
										{mainArticles.slice(2, 4).map((article: any) => (
											<article class="business-stacked-card">
												<div class="business-stacked-image-wrapper">
													<a href={getArticleUrl(article)} class="business-stacked-image-link">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" />
														) : (
															<div class="placeholder-small">üì∞</div>
														)}
													</a>
												</div>
												<div class="business-stacked-content">
													<a href={`/categories/${cat.slug}`} class="category-tag category-link-safe">{cat.displayName}</a>
													<h4><a href={getArticleUrl(article)}>{article.title}</a></h4>
													<p>{article.excerpt}</p>
													<div class="business-stacked-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
								</div>
							</div>
							<div class="sidebar sticky-col marketing-sidebar">
								<CategorySidebar categorySlug={cat.slug} articles={allCategoryArticles} />
							</div>
						</div>
					</section>
				);
			}

			// AI AGENTS SECTION: Use Business section layout and markup
			if (cat.slug === 'ai-agents') {
				return (
					<section class="content-section" id={cat.slug}>
						<div class="section-header">
							<h2 class="section-title"><a href={`/categories/${cat.slug}`}>{cat.displayName}</a></h2>
							<a href={`/categories/${cat.slug}`} class="view-all-link">View All ‚Üí</a>
						</div>
						<div class="section-layout ai-agents-section-layout">
							<div class="main-content">
								<div class="grid-layout-special">
									<div class="top-row">
										{mainArticles.slice(0, 2).map((article: any) => (
											<article class="large-card">
												<a href={getArticleUrl(article)} class="card-image-link">
													<div class="card-image" style="aspect-ratio: 16/9; height: 250px;">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" style="object-fit: cover; width: 100%; height: 100%;" />
														) : (
															<div class="placeholder-image">üì∞</div>
														)}
														<div class="card-image-gradient" style="position:absolute;left:0;bottom:0;width:100%;height:40%;background:linear-gradient(180deg,rgba(24,25,26,0) 0%,rgba(24,25,26,0.7) 100%);"></div>
													</div>
												</a>
												<div class="card-content">
													<a href={`/categories/${cat.slug}`} class="category-tag category-link-safe">{cat.displayName}</a>
													<div style="height: 16px;"></div>
													<h3 style="font-weight:800;"><a href={getArticleUrl(article)}>{article.title}</a></h3>
													<p>{article.excerpt}</p>
													<div class="card-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
									<div class="business-bottom-row">
										{mainArticles.slice(2, 4).map((article: any) => (
											<article class="business-stacked-card">
												<div class="business-stacked-image-wrapper">
													<a href={getArticleUrl(article)} class="business-stacked-image-link">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" />
														) : (
															<div class="placeholder-small">üì∞</div>
														)}
													</a>
												</div>
												<div class="business-stacked-content">
													<a href={`/categories/${cat.slug}`} class="category-tag category-link-safe">{cat.displayName}</a>
													<h4><a href={getArticleUrl(article)}>{article.title}</a></h4>
													<p>{article.excerpt}</p>
													<div class="business-stacked-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
								</div>
							</div>
							<div class="sidebar sticky-col ai-agents-sidebar">
								<CategorySidebar categorySlug={cat.slug} articles={allCategoryArticles} />
							</div>
						</div>
					</section>
				);
			}

			// CREATIVE SECTION: Use Business section layout and markup
			if (cat.slug === 'creative') {
				return (
					<section class="content-section" id={cat.slug}>
						<div class="section-header">
							<h2 class="section-title"><a href={`/categories/${cat.slug}`}>{cat.displayName}</a></h2>
							<a href={`/categories/${cat.slug}`} class="view-all-link">View All ‚Üí</a>
						</div>
						<div class="section-layout creative-section-layout">
							<div class="main-content">
								<div class="grid-layout-special">
									<div class="top-row">
										{mainArticles.slice(0, 2).map((article: any) => (
											<article class="large-card">
												<a href={getArticleUrl(article)} class="card-image-link">
													<div class="card-image" style="aspect-ratio: 16/9; height: 250px;">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" style="object-fit: cover; width: 100%; height: 100%;" />
														) : (
															<div class="placeholder-image">üì∞</div>
														)}
														<div class="card-image-gradient" style="position:absolute;left:0;bottom:0;width:100%;height:40%;background:linear-gradient(180deg,rgba(24,25,26,0) 0%,rgba(24,25,26,0.7) 100%);"></div>
													</div>
												</a>
												<div class="card-content">
													<a href={`/categories/${cat.slug}`} class="category-tag category-link-safe">{cat.displayName}</a>
													<div style="height: 16px;"></div>
													<h3 style="font-weight:800;"><a href={getArticleUrl(article)}>{article.title}</a></h3>
													<p>{article.excerpt}</p>
													<div class="card-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
									<div class="business-bottom-row">
										{mainArticles.slice(2, 4).map((article: any) => (
											<article class="business-stacked-card">
												<div class="business-stacked-image-wrapper">
													<a href={getArticleUrl(article)} class="business-stacked-image-link">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" />
														) : (
															<div class="placeholder-small">üì∞</div>
														)}
													</a>
												</div>
												<div class="business-stacked-content">
													<a href={`/categories/${cat.slug}`} class="category-tag category-link-safe">{cat.displayName}</a>
													<h4><a href={getArticleUrl(article)}>{article.title}</a></h4>
													<p>{article.excerpt}</p>
													<div class="business-stacked-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
								</div>
							</div>
							<div class="sidebar sticky-col creative-sidebar">
								<CategorySidebar categorySlug={cat.slug} articles={allCategoryArticles} />
							</div>
						</div>
					</section>
				);
			}

			// BUSINESS SECTION: restore original layout and card markup
			if (cat.slug === 'business') {
				return (
					<section class="content-section" id={cat.slug}>
						<div class="section-header">
							<h2 class="section-title"><a href={`/categories/${cat.slug}`}>{cat.displayName}</a></h2>
							<a href={`/categories/${cat.slug}`} class="view-all-link">View All ‚Üí</a>
						</div>
						<div class="section-layout">
							<div class="main-content">
								<div class="grid-layout-special">
									<div class="top-row">
										{mainArticles.slice(0, 2).map((article: any) => (
											<article class="large-card">
												<a href={getArticleUrl(article)} class="card-image-link">
													<div class="card-image" style="aspect-ratio: 16/9;">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" style="object-fit: cover; width: 100%; height: 100%;" />
														) : (
															<div class="placeholder-image">üì∞</div>
														)}
														<div class="card-image-gradient" style="position:absolute;left:0;bottom:0;width:100%;height:40%;background:linear-gradient(180deg,rgba(24,25,26,0) 0%,rgba(24,25,26,0.7) 100%);"></div>
													</div>
												</a>
												<div class="card-content">
													<a href="/categories/business" class="category-tag category-link-safe">Business</a>
													<div style="height: 16px;"></div>
													<h3 style="font-weight:800;"><a href={getArticleUrl(article)}>{article.title}</a></h3>
													<p>{article.excerpt}</p>
													<div class="card-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
									<div class="business-bottom-row">
										{mainArticles.slice(2, 4).map((article: any) => (
											<article class="business-stacked-card">
												<div class="business-stacked-image-wrapper">
													<a href={getArticleUrl(article)} class="business-stacked-image-link">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" />
														) : (
															<div class="placeholder-small">üì∞</div>
														)}
													</a>
												</div>
												<div class="business-stacked-content">
													<a href="/categories/business" class="category-tag category-link-safe">Business</a>
													<h4><a href={getArticleUrl(article)}>{article.title}</a></h4>
													<p>{article.excerpt}</p>
													<div class="business-stacked-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
								</div>
							</div>
							<div class="sidebar sticky-col">
								<CategorySidebar categorySlug={cat.slug} articles={allCategoryArticles} />
							</div>
						</div>
					</section>
				);
			}

			// PRODUCTIVITY SECTION: Use Business section layout and markup
			if (cat.slug === 'productivity') {
				return (
					<section class="content-section performance-optimized" id={cat.slug}>
						<div class="section-header">
							<h2 class="section-title"><a href={`/categories/${cat.slug}`}>{cat.displayName}</a></h2>
							<a href={`/categories/${cat.slug}`} class="view-all-link">View All ‚Üí</a>
						</div>
						<div class="section-layout marketing-section-layout">
							<div class="main-content">
								<div class="grid-layout-special">
									<div class="top-row">
										{mainArticles.slice(0, 2).map((article: any) => (
											<article class="large-card">
												<a href={getArticleUrl(article)} class="card-image-link">
													<div class="card-image" style="aspect-ratio: 16/9; height: 250px;">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" style="object-fit: cover; width: 100%; height: 100%;" />
														) : (
															<div class="placeholder-image">üì∞</div>
														)}
														<div class="card-image-gradient" style="position:absolute;left:0;bottom:0;width:100%;height:40%;background:linear-gradient(180deg,rgba(24,25,26,0) 0%,rgba(24,25,26,0.7) 100%);"></div>
													</div>
												</a>
												<div class="card-content">
													<a href={`/categories/${cat.slug}`} class="category-tag category-link-safe">{cat.displayName}</a>
													<div style="height: 16px;"></div>
													<h3 style="font-weight:800;"><a href={getArticleUrl(article)}>{article.title}</a></h3>
													<p>{article.excerpt}</p>
													<div class="card-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
									<div class="business-bottom-row">
										{mainArticles.slice(2, 4).map((article: any) => (
											<article class="business-stacked-card">
												<div class="business-stacked-image-wrapper">
													<a href={getArticleUrl(article)} class="business-stacked-image-link">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" />
														) : (
															<div class="placeholder-small">üì∞</div>
														)}
													</a>
												</div>
												<div class="business-stacked-content">
													<a href={`/categories/${cat.slug}`} class="category-tag category-link-safe">{cat.displayName}</a>
													<h4><a href={getArticleUrl(article)}>{article.title}</a></h4>
													<p>{article.excerpt}</p>
													<div class="business-stacked-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
								</div>
							</div>
							<div class="sidebar marketing-sidebar">
								<CategorySidebar categorySlug={cat.slug} articles={allCategoryArticles} />
							</div>
						</div>
					</section>
				);
			}

			// ECOMMERCE SECTION: Use Creative section layout and markup
			if (cat.slug === 'ecommerce') {
				return (
					<section class="content-section performance-optimized" id={cat.slug}>
						<div class="section-header">
							<h2 class="section-title"><a href={`/categories/${cat.slug}`}>{cat.displayName}</a></h2>
							<a href={`/categories/${cat.slug}`} class="view-all-link">View All ‚Üí</a>
						</div>
						<div class="section-layout creative-section-layout">
							<div class="main-content">
								<div class="grid-layout-special">
									<div class="top-row">
										{mainArticles.slice(0, 2).map((article: any) => (
											<article class="large-card">
												<a href={getArticleUrl(article)} class="card-image-link">
													<div class="card-image" style="aspect-ratio: 16/9; height: 250px;">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" style="object-fit: cover; width: 100%; height: 100%;" />
														) : (
															<div class="placeholder-image">üì∞</div>
														)}
														<div class="card-image-gradient" style="position:absolute;left:0;bottom:0;width:100%;height:40%;background:linear-gradient(180deg,rgba(24,25,26,0) 0%,rgba(24,25,26,0.7) 100%);"></div>
													</div>
												</a>
												<div class="card-content">
													<a href={`/categories/${cat.slug}`} class="category-tag category-link-safe">{cat.displayName}</a>
													<div style="height: 16px;"></div>
													<h3 style="font-weight:800;"><a href={getArticleUrl(article)}>{article.title}</a></h3>
													<p>{article.excerpt}</p>
													<div class="card-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
									<div class="business-bottom-row">
										{mainArticles.slice(2, 4).map((article: any) => (
											<article class="business-stacked-card">
												<div class="business-stacked-image-wrapper">
													<a href={getArticleUrl(article)} class="business-stacked-image-link">
														{article.featuredImage ? (
															<img src={article.featuredImage} alt={article.title} loading="lazy" />
														) : (
															<div class="placeholder-small">üì∞</div>
														)}
													</a>
												</div>
												<div class="business-stacked-content">
													<a href={`/categories/${cat.slug}`} class="category-tag category-link-safe">{cat.displayName}</a>
													<h4><a href={getArticleUrl(article)}>{article.title}</a></h4>
													<p>{article.excerpt}</p>
													<div class="business-stacked-meta">
														<span class="author">
															By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>{article.author?.name || 'Anonymous'}</a>
														</span>
														<span class="date">{formatDate(article.publishedAt)}</span>
														<span class="read-time">{Math.max(1, Math.ceil(((article.excerpt ? article.excerpt.split(/\s+/).length : 0) + (article.content ? portableTextToPlainText(article.content).split(/\s+/).length : 0)) / 200))} min read</span>
													</div>
												</div>
											</article>
										))}
									</div>
								</div>
							</div>
							<div class="sidebar marketing-sidebar">
								<CategorySidebar categorySlug={cat.slug} articles={allCategoryArticles} />
							</div>
						</div>
					</section>
				);
			}

			// Default fallback (should not be hit)
			return null;
		})}
	</div>
</section>

<style>
	.aibuzz-layout {
		padding: 2rem 0;
		background: var(--bg-primary);
		position: relative;
		z-index: 1;
		margin-bottom: 0;
		overflow: visible;
		/* Avoid properties that break sticky on descendants */
		transform: none !important;
		contain: none !important;
		filter: none !important;
	}

	.layout-container {
		max-width: 1200px;
		margin: 0 auto;
		padding: 0 2rem;
		position: relative;
		z-index: 1;
		padding-bottom: 0;
		overflow: visible;
		/* Ensure sticky descendants can reference the body scroll container */
		transform: none !important;
		contain: none !important;
		filter: none !important;
	}

	.content-section {
		margin-bottom: 4rem;
	}

	.content-section:last-child {
		margin-bottom: 0;
	}

	.section-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 2rem;
		margin-top: 2rem;
		padding-bottom: 1rem;
		border-bottom: 2px solid rgba(0, 212, 255, 0.2);
	}

	.section-title {
		font-size: 2.5rem;
		font-weight: 700;
		color: #ffffff;
		margin: 0;
	}

	.section-title a {
		position: relative;
		z-index: 1;
		background: linear-gradient(135deg, #00d4ff 0%, #0066ff 100%);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
		text-decoration: none;
		transition: text-decoration 0.2s, color 0.2s;
		cursor: pointer;
	}

	.section-title a::after {
		content: "";
		position: absolute;
		left: 50%;
		top: 50%;
		width: 120%;
		height: 70%;
		transform: translate(-50%, -50%);
		background: radial-gradient(circle, rgba(0,212,255,0.35) 0%, rgba(0,212,255,0.10) 80%, transparent 100%);
		filter: blur(12px);
		opacity: 0;
		transition: opacity 0.3s;
		z-index: -1;
		pointer-events: none;
	}

	.section-title a:hover {
		text-decoration: underline;
		-webkit-text-fill-color: unset;
		color: #00d4ff;
	}

	.section-title a:hover::after {
		opacity: 1;
	}

	.view-all-link {
		color: #00d4ff;
		text-decoration: none;
		font-weight: 600;
		font-size: 1rem;
		transition: color 0.2s ease;
		padding: 0.5rem 1rem;
		border-radius: 8px;
		background: rgba(0, 212, 255, 0.1);
		border: 1px solid rgba(0, 212, 255, 0.2);
	}

	.view-all-link:hover {
		color: #ffffff;
		background: rgba(0, 212, 255, 0.2);
	}

	/* Section Layout */
	.section-layout {
		display: grid;
		grid-template-columns: minmax(0, 1fr) 340px;
		gap: 2rem;
		align-items: start; /* ensure grid items don't stretch in a way that could interfere */
		position: relative; /* Establish positioning context for sticky children */
		/* Removed min-height: 2000px; as it was for testing purposes. The sticky effect will now stop based on the actual content height. */
		overflow: visible !important; /* do not clip sticky descendants */
		contain: none !important; /* prevent new containing block */
		transform: none !important; /* do not create containing block */
		filter: none !important;
	}

	.main-content {
		width: 100%;
		max-width: 1200px;
		margin: 0 auto;
		flex: none;
	}

	/* Grid Layout for Main Content */
	.grid-layout-special {
		width: 100%;
		max-width: 1200px;
		margin: 0 auto;
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	/* Top Row: 2 Large Cards Side by Side */
	.top-row {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 2rem;
		flex: 2;
	}

	.large-card {
		background: #1a1a1b;
		border: 1px solid rgba(255, 255, 255, 0.1);
		border-radius: 16px;
		overflow: hidden;
		transition: all 0.2s ease;
		display: flex;
		flex-direction: column;
		will-change: transform;
	}

	.large-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 15px 30px rgba(0, 212, 255, 0.15);
		border-color: rgba(0, 212, 255, 0.3);
	}

	.card-image {
		position: relative;
		height: 250px;
		overflow: hidden;
	}

	.card-image-link {
		display: block;
		text-decoration: none;
		color: inherit;
		cursor: pointer;
	}

	.card-image img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform 0.2s ease;
		will-change: transform;
	}

	.large-card:hover .card-image img {
		transform: scale(1.02);
	}

	.placeholder-image {
		width: 100%;
		height: 100%;
		background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 102, 255, 0.2) 100%);
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 4rem;
	}

	.review-score {
		position: absolute;
		top: 15px;
		right: 15px;
		background: linear-gradient(135deg, #00d4ff 0%, #0066ff 100%);
		color: white;
		padding: 0.5rem 1rem;
		border-radius: 20px;
		font-weight: 700;
		font-size: 1.1rem;
	}

	.card-content {
		padding: 2rem;
		flex: 1;
		display: flex;
		flex-direction: column;
	}

	/* Prevent category tags from being stretched by flex container */
	.card-content .category-tag,
	.stacked-content .category-tag {
		align-self: flex-start;
		width: auto;
		flex-shrink: 0;
		/* This should override any display property from category-link-safe */
	}

	.category-tag {
		background: rgba(0, 212, 255, 0.2);
		color: #00d4ff;
		padding: 0.2rem 0.5rem;
		border-radius: 12px;
		font-size: 0.65rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		transition: all 0.3s ease;
	}

	.category-tag:hover {
		transform: translateY(-2px);
		box-shadow: 0 6px 16px rgba(0, 212, 255, 0.4);
		background: rgba(0, 212, 255, 0.3);
		color: #ffffff;
	}

	.card-content h3 {
		font-size: 1.4rem;
		font-weight: 600;
		margin: 0 0 1rem 0;
		line-height: 1.3;
		flex: 1;
	}

	.card-content h3 a {
		color: #ffffff;
		text-decoration: none;
		display: inline-block;
		transition: transform 0.1s ease;
		outline: none;
	}

	.card-content h3 a:hover {
		color: #00d4ff;
		transform: translateX(2px);
	}

	.card-content p {
		color: #b3b3b3;
		line-height: 1.6;
		margin-bottom: 1.5rem;
		font-size: 0.95rem;
	}

	.review-stars {
		color: #ffb800;
		margin-bottom: 1rem;
		font-size: 1.1rem;
	}

	.ai-agent-indicators {
		display: flex;
		gap: 1rem;
		margin-bottom: 1rem;
	}

	.specialization, .capability {
		background: rgba(255, 184, 0, 0.1);
		color: #ffb800;
		padding: 0.25rem 0.75rem;
		border-radius: 12px;
		font-size: 0.8rem;
		font-weight: 500;
	}

	.tutorial-indicators {
		display: flex;
		gap: 1rem;
		margin-bottom: 1rem;
	}

	.difficulty, .duration {
		background: rgba(168, 85, 247, 0.1);
		color: #a855f7;
		padding: 0.25rem 0.75rem;
		border-radius: 12px;
		font-size: 0.8rem;
		font-weight: 500;
	}

	.card-meta {
		display: flex;
		justify-content: space-between;
		align-items: center;
		font-size: 0.85rem;
		color: #666666;
		border-top: 1px solid rgba(255, 255, 255, 0.1);
		padding-top: 1rem;
		margin-top: auto;
	}

	.card-meta .read-time {
		color: #00d4ff;
		font-weight: 600;
		font-size: 0.85rem;
		margin-left: 0.5em;
	}

	/* Bottom Row: 2 Large Cards Side by Side */
	.bottom-row {
		display: grid;
		grid-template-columns: 1fr 1fr;
		gap: 2rem;
		flex: 1;
	}

	/* Medium Card: Shorter height for second row */
	.medium-card {
		background: #1a1a1b;
		border: 1px solid rgba(255, 255, 255, 0.1);
		border-radius: 16px;
		overflow: hidden;
		transition: all 0.2s ease;
		display: flex;
		flex-direction: column;
		will-change: transform;
	}

	.medium-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 15px 30px rgba(0, 212, 255, 0.15);
		border-color: rgba(0, 212, 255, 0.3);
	}

	.medium-card .card-image {
		height: 125px; /* Reduced from 180px to 125px (about half of large-card 250px) */
	}

	.medium-card .card-content {
		padding: 1rem;
		display: flex;
		flex-direction: column;
		justify-content: space-between;
		min-height: 140px; /* Ensure consistent height */
	}

	/* Prevent category tags from being stretched by flex container */
	.medium-card .card-content .category-tag {
		align-self: flex-start;
		width: auto;
		flex-shrink: 0;
	}

	.medium-card .card-content h3 {
		font-size: 1.1rem; /* Smaller title */
		margin: 0 0 0.5rem 0; /* Reduced margins */
		line-height: 1.3;
	}

	.medium-card .card-content h3 a {
		color: #ffffff;
		text-decoration: none;
		display: inline-block;
		transition: transform 0.1s ease;
		outline: none;
	}

	.medium-card .card-content h3 a:hover {
		color: #00d4ff;
		transform: translateX(2px);
	}

	.medium-card .card-content p {
		font-size: 0.85rem; /* Smaller text */
		margin-bottom: 0.75rem; /* Reduced margin */
		line-height: 1.4;
		/* Limit to 2 lines */
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.medium-card .ai-agent-indicators {
		margin-bottom: 0.75rem; /* Reduced margin */
		gap: 0.5rem; /* Tighter spacing */
	}

	.medium-card .specialization, 
	.medium-card .capability {
		padding: 0.2rem 0.5rem; /* Smaller padding */
		font-size: 0.7rem; /* Smaller font */
		border-radius: 8px;
	}

	.medium-card .card-meta {
		margin-top: auto; /* Push to bottom */
		padding-top: 0.75rem; /* Reduced padding */
		font-size: 0.75rem; /* Smaller font */
		border-top: 1px solid rgba(255, 255, 255, 0.1);
	}

	/* Tutorials Bottom Row: Stacked Cards Vertically */
	.tutorials-bottom {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	/* News Bottom Row: Stacked Cards Vertically */
	.news-bottom {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	/* Reviews Bottom Row: Stacked Cards Vertically */
	.reviews-bottom {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	/* AI Agents Bottom Row: Stacked Cards Vertically */
	.ai-agents-bottom {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.stacked-card {
		background: #1a1a1b;
		border: 1px solid rgba(255, 255, 255, 0.1);
		border-radius: 12px;
		padding: 2rem;
		display: flex;
		gap: 1.5rem;
		transition: all 0.2s ease;
		will-change: transform;
	}

	.stacked-card:hover {
		transform: translateX(4px);
		box-shadow: 0 8px 20px rgba(0, 212, 255, 0.1);
		border-color: rgba(0, 212, 255, 0.4);
	}

	.stacked-image {
		width: 120px;
		height: 144px; /* Increased from 120px to 144px (20% more) */
		border-radius: 8px;
		overflow: hidden;
		flex-shrink: 0;
	}

	.stacked-image-link {
		display: block;
		text-decoration: none;
		color: inherit;
		cursor: pointer;
		flex-shrink: 0;
	}

	.stacked-image img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.placeholder-small {
		width: 100%;
		height: 100%;
		background: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 102, 255, 0.2) 100%);
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 2rem;
	}

	.stacked-content {
		flex: 1;
		display: flex;
		flex-direction: column;
	}

	.stacked-content h4 {
		font-size: 1.1rem;
		font-weight: 600;
		margin: 0 0 0.75rem 0;
		line-height: 1.3;
	}

	.stacked-content h4 a {
		color: #ffffff;
		text-decoration: none;
		display: inline-block;
		transition: transform 0.1s ease;
		outline: none;
	}

	.stacked-content h4 a:hover {
		color: #00d4ff;
		transform: translateX(2px);
	}

	.stacked-meta {
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 1rem;
		font-size: 0.8rem;
		color: #666666;
		margin-top: auto;
	}

	/* Responsive Design */
	@media (max-width: 1200px) {
		.section-layout {
			grid-template-columns: 1fr 300px;
			gap: 1.5rem;
		}
		
		.layout-container {
			padding: 0 1.5rem;
		}
	}

	@media (max-width: 768px) {
		.aibuzz-layout {
			padding: 1rem 0;
		}
		
		.layout-container {
			padding: 0 1rem;
		}
		
		.section-layout {
			grid-template-columns: 1fr;
			gap: 1rem;
		}
		
		.content-section {
			margin-bottom: 2rem;
		}
		
		.section-header {
			margin-bottom: 1.5rem;
			margin-top: 1.5rem;
		}
		
		.section-title {
			font-size: 2rem;
		}
		
		/* Top Row: Stack cards vertically on mobile */
		.top-row {
			grid-template-columns: 1fr;
			gap: 1rem;
		}
		
		/* 2x2 Grid: Stack cards vertically on mobile */
		.grid-layout-2x2 {
			grid-template-columns: 1fr;
			grid-template-rows: auto;
			gap: 1rem;
		}
		
		/* Tutorials and News bottom rows: Keep vertical stacking */
		.tutorials-bottom,
		.news-bottom,
		.reviews-bottom,
		.ai-agents-bottom {
			gap: 1rem;
		}
		
		.large-card {
			margin-bottom: 0;
		}
		
		.medium-card {
			margin-bottom: 0;
		}
		
		.grid-card {
			margin-bottom: 0;
		}
		
		.card-content {
			padding: 1.5rem;
		}
		
		/* Prevent category tags from being stretched by flex container on mobile */
		.card-content .category-tag {
			align-self: flex-start;
			width: auto;
			flex-shrink: 0;
		}
		
		.card-content h3 {
			font-size: 1.2rem;
		}
		
		.stacked-card {
			padding: 1rem;
			gap: 1rem;
		}
		
		.stacked-image {
			width: 80px;
			height: 80px;
		}
		
		.stacked-content h4 {
			font-size: 1rem;
		}
		
		/* Prevent category tags from being stretched by flex container on mobile */
		.stacked-content .category-tag {
			align-self: flex-start;
			width: auto;
			flex-shrink: 0;
		}
		
		/* Ensure proper spacing for footer */
		.aibuzz-layout {
			/* Remove min-height that might cause issues */
		}
		
		/* AI Agent indicators on mobile */
		.ai-agent-indicators {
			flex-direction: column;
			gap: 0.25rem;
		}
		
		.ai-agent-indicators span {
			font-size: 0.8rem;
		}
		
		/* Medium card mobile adjustments */
		.medium-card .card-content {
			padding: 0.75rem;
			min-height: auto;
		}
		
		/* Prevent category tags from being stretched by flex container on mobile */
		.medium-card .card-content .category-tag {
			align-self: flex-start;
			width: auto;
			flex-shrink: 0;
		}
		
		.medium-card .card-content h3 {
			font-size: 1rem;
		}
		
		.medium-card .card-content p {
			font-size: 0.8rem;
			-webkit-line-clamp: 3; /* Allow 3 lines on mobile */
		}
		
		.medium-card .ai-agent-indicators {
			flex-direction: column;
			gap: 0.25rem;
		}
		
		.medium-card .specialization,
		.medium-card .capability {
			font-size: 0.65rem;
		}
		
		/* Tutorial indicators on mobile */
		.tutorial-indicators {
			flex-direction: column;
			gap: 0.25rem;
		}
		
		.tutorial-indicators span {
			font-size: 0.8rem;
		}
	}

	@media (max-width: 480px) {
		.aibuzz-layout {
			padding: 0.5rem 0;
		}
		
		.layout-container {
			padding: 0 0.75rem;
		}
		
		.section-header {
			flex-direction: column;
			gap: 1rem;
			text-align: center;
			margin-bottom: 1rem;
		}
		
		.section-title {
			font-size: 1.8rem;
		}
		
		.view-all-link {
			align-self: center;
			font-size: 0.9rem;
			padding: 0.4rem 0.8rem;
		}
		
		.content-section {
			margin-bottom: 1.5rem;
		}
		
		.card-content {
			padding: 1rem;
		}
		
		/* Prevent category tags from being stretched by flex container on mobile */
		.card-content .category-tag {
			align-self: flex-start;
			width: auto;
			flex-shrink: 0;
		}
		
		.card-content h3 {
			font-size: 1.1rem;
		}
		
		.card-content p {
			font-size: 0.9rem;
		}
		
		.stacked-card {
			flex-direction: column;
			text-align: center;
			padding: 0.75rem;
		}
		
		.stacked-image {
			width: 100%;
			height: 120px;
		}
		
		.stacked-content h4 {
			font-size: 0.95rem;
		}
		
		/* Prevent category tags from being stretched by flex container on mobile */
		.stacked-content .category-tag {
			align-self: flex-start;
			width: auto;
			flex-shrink: 0;
		}
		
		/* AI Agent indicators on mobile */
		.ai-agent-indicators {
			flex-direction: column;
			gap: 0.25rem;
		}
		
		.ai-agent-indicators span {
			font-size: 0.8rem;
		}
		
		/* Tutorial indicators on mobile */
		.tutorial-indicators {
			flex-direction: column;
			gap: 0.25rem;
		}
		
		.tutorial-indicators span {
			font-size: 0.8rem;
		}
		
		/* Review stars on mobile */
		.review-stars {
			font-size: 0.9rem;
		}
		
		/* Ensure footer is visible */
		.aibuzz-layout {
			/* Remove min-height that might cause issues */
		}
		
		/* Prevent category tags from being stretched by flex container on mobile */
		.stacked-content .category-tag {
			align-self: flex-start;
			width: auto;
			flex-shrink: 0;
		}
		
		.stacked-meta {
			flex-direction: column;
			gap: 0.25rem;
			align-items: center;
		}
	}

	/* Extra small devices */
	@media (max-width: 360px) {
		.layout-container {
			padding: 0 0.5rem;
		}
		
		.section-title {
			font-size: 1.6rem;
		}
		
		.card-content {
			padding: 0.75rem;
		}
		
		/* Prevent category tags from being stretched by flex container on mobile */
		.card-content .category-tag {
			align-self: flex-start;
			width: auto;
			flex-shrink: 0;
		}
	}

	/* 2x2 Grid Layout for AI Agents */
	.grid-layout-2x2 {
		display: grid;
		grid-template-columns: 1fr 1fr;
		grid-template-rows: 1fr 1fr;
		gap: 2rem;
		height: 100%;
	}

	.grid-card {
		background: #1a1a1b;
		border: 1px solid rgba(255, 255, 255, 0.1);
		border-radius: 16px;
		overflow: hidden;
		transition: all 0.3s ease;
		display: flex;
		flex-direction: column;
		height: 100%;
	}

	.grid-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 8px 32px rgba(0, 212, 255, 0.2);
		border-color: rgba(0, 212, 255, 0.4);
	}

	/* Medium card mobile adjustments */
	.medium-card .card-content {
		padding: 0.75rem;
		min-height: auto;
	}
	
	.medium-card .card-content h3 {
		font-size: 1rem;
	}
	
	.medium-card .card-content p {
		font-size: 0.8rem;
		-webkit-line-clamp: 3; /* Allow 3 lines on mobile */
	}
	
	.medium-card .ai-agent-indicators {
		flex-direction: column;
		gap: 0.25rem;
	}
	
	.medium-card .specialization,
	.medium-card .capability {
		font-size: 0.65rem;
	}

	/* Author link styles */
	.author-link {
		color: #666666;
		text-decoration: none;
		transition: all 0.3s ease;
		border-radius: 4px;
		padding: 2px 4px;
		margin: -2px -4px;
	}

	.author-link:hover {
		color: #00d4ff;
		text-decoration: none;
		transform: translateY(-1px);
	}

	.author-link:focus {
		outline: 2px solid #00d4ff;
		outline-offset: 2px;
		background: rgba(0, 212, 255, 0.1);
	}

	/* Ensure author text maintains proper spacing */
	.author {
		display: inline-flex;
		align-items: center;
		gap: 0.25rem;
	}

	/* Business Category Special Layout */
	.business-stacked-layout {
		display: flex !important;
		flex-direction: column !important;
		width: 100% !important;
		max-width: 100% !important;
		gap: 1.5rem !important;
	}

	/* Override bottom-row grid for Business category */
	.business-bottom-row {
		display: flex !important;
		flex-direction: column !important;
		width: 100% !important;
		max-width: 100% !important;
		gap: 1.5rem !important;
		grid-template-columns: none !important;
	}

	/* Ensure business cards take full width */
	.business-bottom-row .business-stacked-card {
		width: 100% !important;
		max-width: 100% !important;
		margin: 0 !important;
	}

	.business-stacked-card {
		display: flex !important;
		flex-direction: row !important;
		align-items: stretch !important;
		width: 100% !important;
		max-width: 100% !important;
		background: #18191a;
		border-radius: 16px;
		box-shadow: 0 4px 16px rgba(0,0,0,0.10);
		border: 1px solid rgba(255,255,255,0.08);
		overflow: hidden;
		transition: all 0.2s ease;
	}

	.business-stacked-image-wrapper {
		display: flex;
		align-items: stretch;
		justify-content: center;
		width: 140px;
		min-width: 140px;
		flex: 0 0 140px;
		align-self: stretch;
		background: #232425;
		overflow: hidden;
		margin: 0;
	}

	.business-stacked-image-link {
		display: block;
		width: 100%;
		height: 100%;
	}

	.business-stacked-image-link img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
		transition: transform 0.2s ease;
	}

	.business-stacked-content {
		flex: 1 1 0%;
		display: flex;
		flex-direction: column;
		justify-content: flex-start;
		padding: 1.3rem 1.5rem 1.3rem 1.2rem;
		min-width: 0;
	}

	.business-stacked-content h4 {
		font-size: 1.08rem;
		font-weight: 600;
		margin: 0 0 0.45rem 0;
		line-height: 1.3;
	}

	.business-stacked-content h4 a {
		color: #fff;
		text-decoration: none;
		display: inline-block;
		transition: color 0.15s, transform 0.1s;
		outline: none;
	}

	.business-stacked-content h4 a:hover {
		color: #00d4ff;
		transform: translateX(2px);
	}

	.business-stacked-content p {
		color: #b3b3b3;
		line-height: 1.5;
		margin: 0 0 0.7rem 0;
		font-size: 0.93rem;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.business-stacked-meta {
		display: flex;
		flex-direction: row;
		align-items: center;
		gap: 1.2em;
		font-size: 0.85rem;
		color: #666666;
		border-top: 1px solid rgba(255,255,255,0.1);
		padding-top: 1rem;
		margin-top: auto;
	}

	.business-stacked-meta .author {
		color: #666666;
		font-weight: 500;
	}

	.business-stacked-meta .date {
		color: #666666;
	}

	@media (max-width: 900px) {
		.business-stacked-card {
			flex-direction: column;
			align-items: stretch !important;
		}
		.business-stacked-image-wrapper {
			width: 100%;
			height: 180px;
			min-width: 0;
		}
		.business-stacked-image-link img {
			border-radius: 16px 16px 0 0;
		}
		.business-stacked-content {
			padding: 1rem;
		}
	}

	.business-stacked-content .category-tag {
		display: inline-block !important;
		width: auto !important;
		max-width: 100% !important;
		align-self: flex-start !important;
		flex-shrink: 0 !important;
		margin-bottom: 0.5rem !important;
	}

	.business-stacked-card:hover {
		transform: translateY(-4px);
		box-shadow: 0 15px 30px rgba(0, 212, 255, 0.15);
		border-color: rgba(0, 212, 255, 0.3);
	}

	.business-stacked-card:hover .business-stacked-image-link img {
		transform: scale(1.02);
	}

	.magazine-card {
		display: flex !important;
		flex-direction: row !important;
		align-items: stretch !important;
		width: 100% !important;
		max-width: 100% !important;
		background: #18191a;
		border-radius: 16px;
		box-shadow: 0 4px 16px rgba(0,0,0,0.10);
		border: 1px solid rgba(255,255,255,0.08);
		overflow: hidden;
		/* Hover effects are inherited from .business-stacked-card */
	}

	.magazine-image-wrapper {
		width: 220px;
		min-width: 220px;
		height: auto;
		aspect-ratio: 16/9;
		flex: 0 0 220px;
		display: flex;
		align-items: flex-start;
		justify-content: center;
		background: #232425;
		position: relative;
		overflow: hidden;
		margin: 0;
	}

	.magazine-image-container {
		position: relative;
		width: 100%;
		height: 100%;
		display: flex;
		align-items: flex-start;
		justify-content: center;
	}

	.magazine-image-container img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		display: block;
		border: none;
	}

	.magazine-image-gradient {
		position: absolute;
		left: 0;
		bottom: 0;
		width: 100%;
		height: 40%;
		background: linear-gradient(180deg, rgba(24,25,26,0) 0%, rgba(24,25,26,0.7) 100%);
		pointer-events: none;
		z-index: 2;
	}

	.magazine-content {
		flex: 1 1 0%;
		display: flex;
		flex-direction: column;
		justify-content: flex-start;
		padding: 1.3rem 1.5rem 1.3rem 1.0rem;
		min-width: 0;
		margin-left: 1.0rem;
	}

	.magazine-title {
		font-size: 1.25rem;
		font-weight: 800;
		margin: 0 0 0.6rem 0;
		line-height: 1.25;
		letter-spacing: -0.01em;
	}

	.magazine-title a {
		color: #fff;
		text-decoration: none;
		display: inline-block;
		transition: color 0.15s, transform 0.1s;
		outline: none;
	}

	.magazine-title a:hover {
		color: #00d4ff;
		transform: translateX(2px);
	}

	.magazine-excerpt {
		color: #b3b3b3;
		line-height: 1.5;
		margin: 0 0 0.7rem 0;
		font-size: 0.97rem;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}

	.magazine-meta {
		display: flex;
		flex-direction: row;
		align-items: center;
		gap: 1.2em;
		font-size: 0.85rem;
		color: #666666;
		border-top: 1px solid rgba(255,255,255,0.1);
		padding-top: 1rem;
		margin-top: auto;
	}

	.magazine-meta .author {
		color: #666666;
		font-weight: 500;
	}

	.magazine-meta .date {
		color: #666666;
	}

	.magazine-meta .read-time {
		color: #00d4ff;
		font-weight: 600;
		font-size: 0.85rem;
		margin-left: 0.5em;
	}

	@media (max-width: 900px) {
		.magazine-card {
			flex-direction: column;
		}
		.magazine-image-wrapper {
			width: 100%;
			min-width: 0;
			height: auto;
			aspect-ratio: 16/9;
			flex: none;
		}
		.magazine-image-container {
			width: 100%;
			height: 100%;
		}
	}

	/* Sidebar column wrapper should NOT set positioning here.
	   Sticky behavior is centralized via the global .sticky-col utility. */
	.sidebar {
		overflow: visible !important;
		position: sticky; /* Make the sidebar sticky */
		top: 2rem; /* Stick to 2rem from the top of the viewport */
		bottom: 2rem; /* Stop sticking 2rem from the bottom of its parent (.section-layout) */
		align-self: flex-start; /* Align to the start of the flex container */
		z-index: 10; /* Ensure it's above other content */
	}

	/* Sidebar inner component should not be sticky; only styling here */
	.category-sidebar {
		width: 340px;
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
		z-index: 10;
		background: rgba(15, 23, 42, 0.3);
		padding: 0.75rem;
		border-radius: 12px;
		border: 1px solid rgba(71, 85, 105, 0.2);
		/* Ensure no transforms/filters/contains that would break ancestor sticky */
		transform: none !important;
		contain: none !important;
		filter: none !important;
		overflow: visible !important;
	}

  .sidebar {
    overflow: visible !important;
    padding: 0 !important;
  }

 /* Restore the beautiful blue sidebar styling (no positioning here) */
 .category-sidebar {
  width: 340px;
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  z-index: 10;
  background: rgba(15, 23, 42, 0.3);
  padding: 0.75rem;
  border-radius: 12px;
  border: 1px solid rgba(71, 85, 105, 0.2);
 }

 .section-layout {
  overflow: visible !important;
 }

	.layout-container {
		overflow: visible !important;
	}

	.aibuzz-layout {
		overflow: visible !important;
	}

	/* --- Editorial Enhancements for Homepage Sections --- */

	/* 3x2 Grid Layout for AI Agents (if >4 articles) */
	.grid-layout-3x2 {
		display: grid;
		grid-template-columns: 1fr 1fr 1fr;
		grid-template-rows: 1fr 1fr;
		gap: 2rem;
		height: 100%;
	}
	@media (max-width: 900px) {
		.grid-layout-3x2 {
			grid-template-columns: 1fr;
			grid-template-rows: auto;
			gap: 1rem;
		}
	}

	/* Trending Badge for AI Agents */
	.badge.trending-badge {
		position: absolute;
		top: 12px;
		left: 12px;
		background: linear-gradient(90deg, #00d4ff 0%, #0066ff 100%);
		color: #fff;
		font-size: 0.78rem;
		font-weight: 700;
		padding: 0.3em 0.9em;
		border-radius: 16px;
		box-shadow: 0 2px 8px rgba(0,212,255,0.12);
		z-index: 3;
		letter-spacing: 0.04em;
		text-transform: uppercase;
		pointer-events: none;
	}

	/* Creative Section: Minimal, image-focused cards */
	.creative-grid {
		gap: 2.2rem;
	}
	.creative-card {
		background: #18191a;
		border-radius: 16px;
		border: 1px solid rgba(255,255,255,0.07);
		box-shadow: 0 2px 8px rgba(0,0,0,0.07);
		display: flex;
		flex-direction: row;
		align-items: stretch;
		transition: box-shadow 0.2s, border-color 0.2s;
		/* Remove overlays, keep image sharp */
	}
	.creative-card:hover {
		box-shadow: 0 8px 32px rgba(0,212,255,0.10);
		border-color: #00d4ff;
	}
	.creative-card .magazine-image-wrapper {
		box-shadow: none;
		background: #232425;
	}
	.creative-meta {
		background: none;
		box-shadow: none;
		padding-left: 1.2rem;
	}
	.creative-meta-row {
		border-top: 1px solid rgba(255,255,255,0.07);
		color: #888;
		font-size: 0.82rem;
		padding-top: 0.7rem;
		margin-top: auto;
	}
	.creative-meta-row .author,
	.creative-meta-row .date {
		color: #888;
	}
	.creative-meta-row .read-time {
		color: #00d4ff;
		font-weight: 600;
	}
	.creative-card .magazine-title a {
		color: #fff;
		font-weight: 700;
		font-size: 1.08rem;
		letter-spacing: -0.01em;
	}
	.creative-card .magazine-title a:hover {
		color: #00d4ff;
	}
	.creative-card .magazine-excerpt {
		color: #b3b3b3;
		font-size: 0.93rem;
		margin-bottom: 0.5rem;
	}

	/* Ensure all meta rows are visually consistent (except Creative is lighter) */
	.card-meta {
		display: flex;
		flex-direction: row;
		align-items: center;
		gap: 1.2em;
		font-size: 0.85rem;
		color: #666666;
		border-top: 1px solid rgba(255,255,255,0.1);
		padding-top: 1rem;
		margin-top: auto;
	}
	.card-meta .author {
		color: #666666;
		font-weight: 500;
	}
	.card-meta .date {
		color: #666666;
	}
	.card-meta .read-time {
		color: #00d4ff;
		font-weight: 600;
		font-size: 0.85rem;
		margin-left: 0.5em;
	}

	/* Marketing Section Layout */
	.marketing-section-layout {
		display: grid;
		grid-template-columns: minmax(0, 1fr) 340px;
		gap: 2rem;
		align-items: stretch;
	}
	.marketing-featured-card {
		grid-column: 1;
		grid-row: 1;
		background: #18191a;
		border-radius: 16px;
		box-shadow: 0 4px 16px rgba(0,0,0,0.10);
		border: 1px solid rgba(255,255,255,0.08);
		display: flex;
		flex-direction: column;
		overflow: hidden;
		transition: box-shadow 0.2s, border-color 0.2s;
	}
	.marketing-featured-card:hover {
		box-shadow: 0 15px 30px rgba(0, 212, 255, 0.15);
		border-color: #00d4ff;
	}
	.marketing-stacked-cards {
		grid-column: 2;
		grid-row: 1;
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
		max-width: 340px;
	}
	.marketing-stacked-card {
		background: #18191a;
		border-radius: 16px;
		box-shadow: 0 4px 16px rgba(0,0,0,0.10);
		border: 1px solid rgba(255,255,255,0.08);
		display: flex;
		flex-direction: row;
		align-items: stretch;
		overflow: hidden;
		transition: box-shadow 0.2s, border-color 0.2s;
	}
	.marketing-stacked-card:hover {
		box-shadow: 0 15px 30px rgba(0, 212, 255, 0.15);
		border-color: #00d4ff;
	}
	.magazine-title a {
		color: #fff;
		text-decoration: none;
		display: inline-block;
		transition: color 0.15s, transform 0.1s;
		outline: none;
	}
	.magazine-title a:hover {
		color: #00d4ff;
		transform: translateX(2px);
	}

	/* Remove margin-top from bottom rows for uniform gap */
	.grid-layout-special > .business-bottom-row,
	.grid-layout-special > .marketing-bottom-row,
	.grid-layout-special > .ai-agents-bottom-row,
	.grid-layout-special > .creative-bottom-row {
		margin-top: 0;
	}

	/* Performance Optimizations - Minimal and safe */
	.performance-optimized {
		/* GPU acceleration */
		/* Removed transform to avoid creating a new containing block that can break sticky positioning */
		/* transform: translateZ(0); */
		backface-visibility: hidden;
	}
	
	/* Performance hints for critical sections */
	.content-section:nth-child(-n+3) img {
		/* High priority loading for above-the-fold content */
		loading: eager;
		fetchpriority: high;
	}
	
	.content-section:nth-child(n+4) img {
		/* Lazy loading for below-the-fold content */
		loading: lazy;
		fetchpriority: low;
	}
</style>

<script>
	// Initialize lazy loading and image optimization with error handling
	document.addEventListener('DOMContentLoaded', function() {
		try {
			// Setup intersection observer for lazy loading
			if ('IntersectionObserver' in window) {
				const imageObserver = new IntersectionObserver((entries, observer) => {
					entries.forEach(entry => {
						if (entry.isIntersecting) {
							const img = entry.target as HTMLImageElement;
							const dataSrc = img.dataset.src;
							
							if (dataSrc) {
								img.src = dataSrc;
								img.classList.remove('lazy');
								observer.unobserve(img);
							}
						}
					});
				}, {
					rootMargin: '50px 0px',
					threshold: 0.01
				});
				
				// Observe all lazy images with error handling
				const lazyImages = document.querySelectorAll('img[data-src]');
				if (lazyImages.length > 0) {
					lazyImages.forEach(img => {
						if (img) imageObserver.observe(img);
					});
				}
			}
			
			// Preload critical images with error handling
			const criticalImages = document.querySelectorAll('img[fetchpriority="high"]');
			if (criticalImages.length > 0 && document.head) {
				criticalImages.forEach(img => {
					try {
						const imgElement = img as HTMLImageElement;
						if (imgElement && imgElement.src) {
							const link = document.createElement('link');
							link.rel = 'preload';
							link.as = 'image';
							link.href = imgElement.src;
							document.head.appendChild(link);
						}
					} catch (e) {
						console.warn('Failed to preload image:', e);
					}
				});
			}
		} catch (error) {
			console.warn('Image optimization initialization failed:', error);
		}
	});
</script>
