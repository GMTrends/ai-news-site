---
// Google Analytics 4 with enhanced tracking
const GA_MEASUREMENT_ID = 'G-70SLYWY20D'
---

<!-- Google Analytics 4 -->
<script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`}></script>
<script define:vars={{ GA_MEASUREMENT_ID }}>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  
  // Enhanced GA4 Configuration
  gtag('config', GA_MEASUREMENT_ID, {
    // Demographics and Interest Reports
    allow_google_signals: true,
    allow_ad_personalization_signals: true,
    
    // Enhanced Measurement Events
    enhanced_measurement: {
      scrolls: true,              // Track 90% scroll depth
      outbound_clicks: true,      // Track external link clicks
      site_search: true,          // Track search usage
      video_engagement: true,     // Track video interactions
      file_downloads: true,       // Track PDF/file downloads
    },
    
    // Custom Parameters
    page_title: document.title,
    page_location: window.location.href,
    
    // User ID tracking (for logged-in users)
    user_id: null, // Set this if you have user accounts
    
    // Custom Dimensions (we'll use these for article tracking)
    custom_map: {
      'dimension1': 'article_category',
      'dimension2': 'article_author', 
      'dimension3': 'article_type'
    }
  });
  
  // Track page views automatically
  gtag('event', 'page_view', {
    page_title: document.title,
    page_location: window.location.href,
    content_group1: 'AI News Site',
    content_group2: document.querySelector('meta[name="article:section"]')?.content || 'Homepage'
  });
</script>

<!-- Enhanced Event Tracking -->
<script>
    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', function() {
      
      // Track article reads (when user scrolls past 50% of article)
      let scrollTracked = false;
      window.addEventListener('scroll', function() {
        if (!scrollTracked && window.scrollY > (document.body.scrollHeight * 0.5)) {
          (window as any).gtag('event', 'article_read_50_percent', {
            event_category: 'engagement',
            event_label: document.title,
            value: 50
          });
          scrollTracked = true;
        }
      });
      
      // Track newsletter signups
      document.addEventListener('submit', function(e: Event) {
        const target = e.target as HTMLElement;
        if (target && (target.classList.contains('subscribe-form') || 
            target.classList.contains('newsletter-form'))) {
          (window as any).gtag('event', 'newsletter_signup', {
            event_category: 'conversion',
            event_label: 'Newsletter Subscription',
            value: 1
          });
        }
      });
      
      // Track search usage
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        searchInput.addEventListener('focus', function() {
          (window as any).gtag('event', 'search_start', {
            event_category: 'engagement',
            event_label: 'Site Search'
          });
        });
      }
      
      // Track category clicks
      document.addEventListener('click', function(e: Event) {
        const target = e.target as HTMLElement;
        if (!target) return;
        
        const categoryLink = target.closest('[href*="/categories/"]') as HTMLAnchorElement;
        if (categoryLink) {
          const categoryName = categoryLink.textContent?.trim() || 'Unknown Category';
          (window as any).gtag('event', 'category_click', {
            event_category: 'navigation',
            event_label: categoryName,
            value: 1
          });
        }
        
        // Track article clicks
        const articleLink = target.closest('[href*="/articles/"]') as HTMLAnchorElement;
        if (articleLink) {
          const articleTitle = articleLink.textContent?.trim() || 'Unknown Article';
          (window as any).gtag('event', 'article_click', {
            event_category: 'content',
            event_label: articleTitle,
            value: 1
          });
        }
        
        // Track external link clicks
        const externalLink = target.closest('a[href^="http"]:not([href*="' + window.location.hostname + '"])') as HTMLAnchorElement;
        if (externalLink) {
          (window as any).gtag('event', 'click', {
            event_category: 'outbound',
            event_label: externalLink.href,
            transport_type: 'beacon'
          });
        }
      });
      
      // Track time on page
      let startTime = Date.now();
      window.addEventListener('beforeunload', function() {
        const timeOnPage = Math.round((Date.now() - startTime) / 1000);
        if (timeOnPage > 10) { // Only track if user stayed more than 10 seconds
          (window as any).gtag('event', 'timing_complete', {
            name: 'time_on_page',
            value: timeOnPage,
            event_category: 'engagement'
          });
        }
      });
    });
  </script>