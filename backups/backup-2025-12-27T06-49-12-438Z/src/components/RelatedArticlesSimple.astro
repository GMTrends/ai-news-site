---
import { getAllArticles, getImageUrl } from '../lib/sanity';

interface Props {
	currentSlug: string;
	currentCategory?: string;
	maxArticles?: number;
}

const { currentSlug, currentCategory, maxArticles = 6 } = Astro.props;

// Get all articles from Sanity
const allPosts = await getAllArticles();

// Filter and prioritize related articles
let sameCategoryPosts: any[] = [];
let otherCategoryPosts: any[] = [];

// Separate posts by category
allPosts.forEach((post: any) => {
	// Exclude current article
	if (post.slug === currentSlug) return;
	
	// Prioritize same category articles
	if (currentCategory && post.category?.name === currentCategory) {
		sameCategoryPosts.push(post);
	} else {
		otherCategoryPosts.push(post);
	}
});

// Sort both arrays by publication date (newest first)
sameCategoryPosts.sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());
otherCategoryPosts.sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime());

// Combine: same category first, then others to fill remaining slots
const relatedPosts = [
	...sameCategoryPosts.slice(0, maxArticles),
	...otherCategoryPosts.slice(0, Math.max(0, maxArticles - sameCategoryPosts.length))
].slice(0, maxArticles);

// Function to calculate reading time
function calculateReadTime(content: string | null | undefined): number {
	if (!content || typeof content !== 'string') {
		return 1; // Default to 1 minute if no content
	}
	const wordsPerMinute = 200;
	const wordCount = content.split(/\s+/).length;
	return Math.ceil(wordCount / wordsPerMinute);
}

// Function to truncate text
function truncateText(text: string, maxLength: number): string {
	if (text.length <= maxLength) return text;
	return text.substring(0, maxLength).trim() + '...';
}
---

{relatedPosts.length > 0 && (
	<section class="related-articles-section">
		<div class="related-articles-container">
			<div class="section-header">
				<h2 class="section-title">Continue Your AI Journey</h2>
				<p class="section-subtitle">Discover more insights to accelerate your entrepreneurial success</p>
			</div>
			
			<div class="articles-grid">
				{relatedPosts.map((post: any) => {
				// Get featured image URL from Sanity (using correct field name)
				const heroImageUrl = getImageUrl(post.featuredImage) || '/images/blog-placeholder-1.jpg';
				
				return (
					<article class="article-card">
						<a href={`/blog/${post.slug}/`} class="card-link">
							<div class="card-image-container">
								<img
									src={`${heroImageUrl}?w=400&q=85&f=webp`}
									alt={post.title}
									width="400"
									height="225"
									loading="lazy"
									decoding="async"
									class="card-image"
								/>
								<div class="card-image-overlay"></div>
								{post.category && (
									<span class="card-category-badge">{post.category.displayName || post.category.name}</span>
								)}
							</div>
							
							<div class="card-content">
								<h3 class="card-title">{post.title}</h3>
								<p class="card-excerpt">{truncateText(post.excerpt || '', 120)}</p>
								
								<div class="card-meta">
									<span class="card-date">
										{new Date(post.publishedAt).toLocaleDateString('en-US', {
											month: 'short',
											day: 'numeric',
											year: 'numeric'
										})}
									</span>
									<span class="card-read-time">{calculateReadTime(post.content || post.body || '')} min read</span>
								</div>
							</div>
						</a>
					</article>
				);
			})}
			</div>
			
			{currentCategory && (
				<div class="section-footer">
					<a href={`/categories/${currentCategory.toLowerCase()}`} class="view-all-link">
						View All {currentCategory} Articles
						<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
							<path d="M7 17l9.2-9.2M17 17V7H7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
						</svg>
					</a>
				</div>
			)}
		</div>
	</section>
)}

<style>
	.related-articles-section {
		margin: 4rem 0 2rem 0;
		padding: 3rem 0;
		background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95));
		border-top: 1px solid rgba(148, 163, 184, 0.1);
		border-bottom: 1px solid rgba(148, 163, 184, 0.1);
	}
	
	.related-articles-container {
		max-width: 1400px;
		margin: 0 auto;
		padding: 0 2rem;
	}
	
	/* Section Header */
	.section-header {
		text-align: center;
		margin-bottom: 3rem;
	}
	
	.section-title {
		font-size: 2.5rem;
		font-weight: 700;
		background: linear-gradient(135deg, #ffffff 0%, #e2e8f0 100%);
		-webkit-background-clip: text;
		-webkit-text-fill-color: transparent;
		background-clip: text;
		margin-bottom: 0.75rem;
		text-shadow: 0 2px 4px rgba(0,0,0,0.3);
	}
	
	.section-subtitle {
		font-size: 1.1rem;
		color: #94a3b8;
		font-weight: 400;
		max-width: 600px;
		margin: 0 auto;
		line-height: 1.6;
	}
	
	/* Articles Grid */
	.articles-grid {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
		gap: 1.5rem;
		margin-bottom: 2rem;
	}
	
	/* Responsive grid adjustments - Optimized for 6 articles */
	@media (min-width: 1200px) {
		.articles-grid {
			grid-template-columns: repeat(3, 1fr);
		}
	}
	
	@media (min-width: 900px) and (max-width: 1199px) {
		.articles-grid {
			grid-template-columns: repeat(3, 1fr);
		}
	}
	
	@media (min-width: 600px) and (max-width: 899px) {
		.articles-grid {
			grid-template-columns: repeat(2, 1fr);
			gap: 1.25rem;
		}
	}
	
	/* Article Cards */
	.article-card {
		background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.04));
		backdrop-filter: blur(12px);
		border: 1px solid rgba(255, 255, 255, 0.1);
		border-radius: 12px;
		overflow: hidden;
		transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		position: relative;
	}
	
	.article-card:hover {
		transform: translateY(-8px) scale(1.02);
		box-shadow: 
			0 20px 40px rgba(0, 0, 0, 0.3),
			0 40px 80px rgba(0, 0, 0, 0.15),
			0 0 30px rgba(0, 224, 255, 0.1);
		border: 1px solid rgba(0, 224, 255, 0.2);
	}
	
	.card-link {
		display: block;
		text-decoration: none;
		color: inherit;
		height: 100%;
	}
	
	/* Card Image */
	.card-image-container {
		position: relative;
		aspect-ratio: 16/9;
		overflow: hidden;
	}
	
	.card-image {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
	}
	
	.article-card:hover .card-image {
		transform: scale(1.1);
	}
	
	.card-image-overlay {
		position: absolute;
		inset: 0;
		background: linear-gradient(
			135deg,
			rgba(0, 0, 0, 0.1) 0%,
			rgba(0, 0, 0, 0.3) 50%,
			rgba(0, 0, 0, 0.6) 100%
		);
		transition: opacity 0.3s ease;
	}
	
	.article-card:hover .card-image-overlay {
		opacity: 0.8;
	}
	
	.card-category-badge {
		position: absolute;
		top: 1rem;
		left: 1rem;
		background: linear-gradient(135deg, rgba(0, 224, 255, 0.9), rgba(49, 130, 206, 0.9));
		color: #ffffff;
		font-size: 0.75rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.025em;
		padding: 0.25rem 0.75rem;
		border-radius: 6px;
		backdrop-filter: blur(8px);
		border: 1px solid rgba(255, 255, 255, 0.2);
	}
	
	/* Card Content */
	.card-content {
		padding: 1.5rem;
	}
	
	.card-title {
		font-size: 1.25rem;
		font-weight: 600;
		color: #ffffff;
		line-height: 1.4;
		margin-bottom: 0.75rem;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
	
	.card-excerpt {
		font-size: 0.95rem;
		color: #94a3b8;
		line-height: 1.6;
		margin-bottom: 1rem;
		display: -webkit-box;
		-webkit-line-clamp: 2;
		-webkit-box-orient: vertical;
		overflow: hidden;
	}
	
	.card-meta {
		display: flex;
		justify-content: space-between;
		align-items: center;
		font-size: 0.85rem;
		color: #64748b;
	}
	
	.card-date,
	.card-read-time {
		font-weight: 500;
	}
	
	/* Section Footer */
	.section-footer {
		text-align: center;
		margin-top: 2.5rem;
	}
	
	.view-all-link {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		color: #00e0ff;
		text-decoration: none;
		font-weight: 600;
		font-size: 1.1rem;
		transition: all 0.3s ease;
		padding: 0.75rem 1.5rem;
		border-radius: 8px;
		background: linear-gradient(135deg, rgba(0, 224, 255, 0.1), rgba(49, 130, 206, 0.1));
		border: 1px solid rgba(0, 224, 255, 0.2);
	}
	
	.view-all-link:hover {
		background: linear-gradient(135deg, rgba(0, 224, 255, 0.2), rgba(49, 130, 206, 0.2));
		border: 1px solid rgba(0, 224, 255, 0.4);
		transform: translateY(-2px);
		box-shadow: 0 8px 25px rgba(0, 224, 255, 0.2);
	}
	
	/* Enhanced Responsive Design */
	@media (max-width: 599px) {
		.related-articles-container {
			padding: 0 1rem;
		}
		
		.articles-grid {
			grid-template-columns: 1fr;
			gap: 1.25rem;
		}
		
		.section-title {
			font-size: 2rem;
		}
		
		.section-subtitle {
			font-size: 1rem;
		}
		
		.card-content {
			padding: 1.25rem;
		}
	}
	
	@media (max-width: 480px) {
		.related-articles-section {
			margin: 2rem 0 1rem 0;
			padding: 2rem 0;
		}
		
		.section-header {
			margin-bottom: 2rem;
		}
		
		.related-articles-container {
			padding: 0 0.75rem;
		}
		
		.articles-grid {
			gap: 1rem;
		}
		
		.card-content {
			padding: 1rem;
		}
		
		.card-title {
			font-size: 1.1rem;
			line-height: 1.3;
		}
		
		.card-excerpt {
			font-size: 0.9rem;
			line-height: 1.5;
		}
		
		.section-title {
			font-size: 1.75rem;
		}
		
		.view-all-link {
			font-size: 1rem;
			padding: 0.625rem 1.25rem;
		}
	}
</style>
