---
/**
 * Strategic Ad Placement Manager - Implements revenue-optimized ad placements
 * Designed to achieve $3000-8000/month revenue target through strategic positioning
 * Avoids ad-blocker detection while maximizing CPM rates
 */

import { adManager, AdBlockerEvasion } from '../lib/ad-manager.ts';
import ContentSpotlight from './ContentSpotlight.astro';

interface Props {
  page: 'home' | 'article' | 'category' | 'tools-comparison';
  position: 'sidebar' | 'content' | 'footer' | 'header';
  priority?: 'premium' | 'high' | 'medium' | 'low';
  customTargeting?: string[];
  className?: string;
}

const { 
  page,
  position,
  priority = 'high',
  customTargeting = [],
  className = ''
} = Astro.props;

// Strategic placement configurations based on page and position
const placementConfigs = {
  'home-sidebar': {
    slots: ['premium-sidebar-1', 'premium-sidebar-2'],
    targeting: ['ai-tools', 'saas', 'enterprise', 'productivity', 'business-automation'],
    revenue: '$15-25 CPM'
  },
  'home-content': {
    slots: ['article-banner-top', 'footer-leaderboard'],
    targeting: ['ai-news', 'technology', 'innovation', 'startups'],
    revenue: '$10-18 CPM'
  },
  'article-sidebar': {
    slots: ['premium-sidebar-1', 'article-content-middle'],
    targeting: ['ai-tools', 'related-content', 'productivity'],
    revenue: '$12-20 CPM'
  },
  'article-content': {
    slots: ['article-banner-top', 'article-content-middle'],
    targeting: ['contextual-ai', 'article-related', 'tools'],
    revenue: '$8-15 CPM'
  },
  'category-sidebar': {
    slots: ['premium-sidebar-2'],
    targeting: ['category-specific', 'ai-tools', 'solutions'],
    revenue: '$6-12 CPM'
  },
  'tools-comparison-sidebar': {
    slots: ['premium-sidebar-1', 'premium-sidebar-2'],
    targeting: ['ai-tools', 'comparison', 'enterprise', 'decision-makers'],
    revenue: '$18-30 CPM'
  }
};

const configKey = `${page}-${position}` as keyof typeof placementConfigs;
const config = placementConfigs[configKey];

if (!config) {
  console.warn(`No placement configuration found for ${configKey}`);
}

// Enhanced targeting based on page context
const getContextualTargeting = (page: string, baseTargeting: string[]): string[] => {
  const contextTargeting = {
    'home': ['homepage-visitors', 'high-intent', 'new-users'],
    'article': ['engaged-readers', 'content-consumers', 'return-visitors'],
    'category': ['category-browsers', 'explorers', 'research-phase'],
    'tools-comparison': ['comparison-shoppers', 'decision-makers', 'high-value', 'enterprise']
  };
  
  return [...baseTargeting, ...(contextTargeting[page as keyof typeof contextTargeting] || []), ...customTargeting];
};

const enhancedTargeting = config ? getContextualTargeting(page, config.targeting) : [];

// Revenue optimization based on page value
const pageValueMultiplier = {
  'home': 1.2,
  'article': 1.0,
  'category': 0.9,
  'tools-comparison': 1.5
}[page] || 1.0;

const positionValueMultiplier = {
  'sidebar': 1.3,
  'content': 1.1,
  'footer': 0.9,
  'header': 1.2
}[position] || 1.0;
---

{config && (
  <div class={`strategic-placement ${page}-${position} ${className}`} data-page={page} data-position={position}>
    
    <!-- Revenue-Optimized Ad Slots -->
    {config.slots.map((slotId, index) => {
      const slotConfig = adManager.getAdSlot(slotId);
      if (!slotConfig || !slotConfig.isActive) return null;
      
      return (
        <div class="placement-slot" data-slot-index={index}>
          <ContentSpotlight 
            slotId={slotId}
            position={slotConfig.position}
            customTargeting={enhancedTargeting}
            priority={priority}
            className={`strategic-${page} position-${position}`}
          />
          
          {/* Revenue Tracking Metadata */}
          <div class="revenue-metadata" style="display: none;">
            <span data-page-value={pageValueMultiplier}></span>
            <span data-position-value={positionValueMultiplier}></span>
            <span data-estimated-cpm={config.revenue}></span>
          </div>
        </div>
      );
    })}

    <!-- AI Tool Spotlight Section (High Affiliate Revenue) -->
    {(page === 'home' || page === 'tools-comparison') && position === 'sidebar' && (
      <div class="ai-tool-spotlight">
        <div class="spotlight-header">
          <h3>üöÄ Featured AI Solutions</h3>
          <span class="affiliate-tag">Partner Spotlight</span>
        </div>
        
        <div class="featured-tools">
          <div class="tool-item premium">
            <div class="tool-icon">ü§ñ</div>
            <div class="tool-content">
              <h4>Enterprise AI Suite</h4>
              <p>Complete business automation platform</p>
              <div class="tool-metrics">
                <span class="commission">40% Commission</span>
                <span class="avg-sale">$299/mo</span>
              </div>
              <button class="tool-cta">Explore Solution ‚Üí</button>
            </div>
          </div>

          <div class="tool-item high-value">
            <div class="tool-icon">‚ö°</div>
            <div class="tool-content">
              <h4>AI Productivity Tools</h4>
              <p>Boost team efficiency by 300%</p>
              <div class="tool-metrics">
                <span class="commission">35% Commission</span>
                <span class="avg-sale">$149/mo</span>
              </div>
              <button class="tool-cta">Get Started ‚Üí</button>
            </div>
          </div>

          <div class="tool-item">
            <div class="tool-icon">üìä</div>
            <div class="tool-content">
              <h4>AI Analytics Platform</h4>
              <p>Data-driven business insights</p>
              <div class="tool-metrics">
                <span class="commission">30% Commission</span>
                <span class="avg-sale">$199/mo</span>
              </div>
              <button class="tool-cta">Try Free ‚Üí</button>
            </div>
          </div>
        </div>
      </div>
    )}

    <!-- Trending AI News Section (Native Advertising) -->
    {page === 'home' && position === 'sidebar' && (
      <div class="trending-news-section">
        <div class="section-header">
          <h3>üìà Trending in AI</h3>
          <span class="native-tag">Sponsored Insights</span>
        </div>
        
        <div class="trending-items">
          <div class="trending-item sponsored">
            <div class="trend-indicator">üî•</div>
            <div class="trend-content">
              <h4>New AI Tool Revolutionizes Content Creation</h4>
              <p>See how businesses are saving 10+ hours weekly</p>
              <span class="sponsor-label">Sponsored by InnovateAI</span>
            </div>
          </div>

          <div class="trending-item">
            <div class="trend-indicator">‚ö°</div>
            <div class="trend-content">
              <h4>Enterprise AI Adoption Surges 400%</h4>
              <p>Latest industry report reveals surprising trends</p>
            </div>
          </div>

          <div class="trending-item sponsored">
            <div class="trend-indicator">üöÄ</div>
            <div class="trend-content">
              <h4>AI Automation Platform Launches Enterprise Suite</h4>
              <p>Exclusive early access for our readers</p>
              <span class="sponsor-label">Sponsored by AutomateAI</span>
            </div>
          </div>
        </div>
      </div>
    )}

    <!-- Newsletter Integration with Affiliate Opportunities -->
    {position === 'sidebar' && (
      <div class="newsletter-monetization">
        <div class="newsletter-header">
          <h3>üìß AI Tools Weekly</h3>
          <span class="subscriber-count">12K+ Subscribers</span>
        </div>
        
        <div class="newsletter-content">
          <p>Get exclusive AI tool reviews, deals, and industry insights delivered weekly.</p>
          
          <div class="newsletter-benefits">
            <div class="benefit">‚ú® Exclusive tool discounts</div>
            <div class="benefit">üéØ Curated AI solutions</div>
            <div class="benefit">üìä Industry trend analysis</div>
          </div>
          
          <div class="newsletter-form">
            <input type="email" placeholder="Enter your email" class="newsletter-input">
            <button class="newsletter-submit">Subscribe Free ‚Üí</button>
          </div>
          
          <div class="newsletter-sponsors">
            <span class="sponsors-label">Newsletter Partners:</span>
            <div class="sponsor-logos">
              <span class="sponsor-logo">ü§ñ TechAI</span>
              <span class="sponsor-logo">‚ö° AutoFlow</span>
              <span class="sponsor-logo">üìä DataBot</span>
            </div>
          </div>
        </div>
      </div>
    )}

    <!-- Social Proof Section -->
    {position === 'sidebar' && (
      <div class="social-proof-section">
        <div class="proof-header">
          <h3>üèÜ Trusted by Professionals</h3>
        </div>
        
        <div class="proof-stats">
          <div class="stat-item">
            <span class="stat-number">50K+</span>
            <span class="stat-label">Monthly Readers</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">12K+</span>
            <span class="stat-label">Newsletter Subscribers</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">500+</span>
            <span class="stat-label">Tools Reviewed</span>
          </div>
        </div>
        
        <div class="testimonials-mini">
          <div class="testimonial-item">
            <p>"Best AI tools resource for entrepreneurs!"</p>
            <span class="testimonial-author">- Sarah K., CEO</span>
          </div>
          <div class="testimonial-item">
            <p>"Saved me hours of research every week."</p>
            <span class="testimonial-author">- Mike R., Developer</span>
          </div>
        </div>
      </div>
    )}

  </div>
)}

<script define:vars={{ page, position, config }}>
  // Strategic placement analytics and optimization
  (function() {
    if (!config) return;
    
    const placementContainer = document.querySelector(`.strategic-placement.${page}-${position}`);
    if (!placementContainer) return;

    // Track placement performance
    const trackPlacementView = () => {
      if (typeof gtag !== 'undefined') {
        gtag('event', 'strategic_placement_view', {
          'page_type': page,
          'position': position,
          'estimated_revenue': config.revenue,
          'targeting': config.targeting.join(',')
        });
      }
    };

    // Intersection Observer for viewability
    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
          trackPlacementView();
          observer.unobserve(entry.target);
        }
      });
    }, { threshold: 0.5 });

    observer.observe(placementContainer);

    // Enhanced click tracking for affiliate links
    placementContainer.addEventListener('click', (e) => {
      const affiliateLink = e.target.closest('.tool-cta, .newsletter-submit, .showcase-cta');
      if (affiliateLink) {
        const toolItem = e.target.closest('.tool-item, .newsletter-monetization, .premium-showcase');
        const commission = toolItem?.querySelector('.commission')?.textContent || 'unknown';
        
        if (typeof gtag !== 'undefined') {
          gtag('event', 'affiliate_click', {
            'page_type': page,
            'position': position,
            'commission_rate': commission,
            'click_type': affiliateLink.className
          });
        }
      }
    });

    // A/B test different placement configurations
    const runPlacementABTest = () => {
      const testVariant = Math.random() > 0.5 ? 'A' : 'B';
      placementContainer.setAttribute('data-test-variant', testVariant);
      
      if (testVariant === 'B') {
        // Test variant with enhanced styling for higher CTR
        const spotlights = placementContainer.querySelectorAll('.content-spotlight');
        spotlights.forEach(spotlight => {
          spotlight.style.background = 'linear-gradient(135deg, #1a1a1b 0%, #2d2d30 100%)';
          spotlight.style.border = '2px solid #00d4ff';
          spotlight.style.boxShadow = '0 8px 32px rgba(0, 212, 255, 0.15)';
        });
      }
    };

    runPlacementABTest();

    // Revenue optimization based on user behavior
    let interactionScore = 0;
    const trackInteractions = () => {
      placementContainer.addEventListener('mouseenter', () => interactionScore += 1);
      placementContainer.addEventListener('click', () => interactionScore += 5);
      placementContainer.addEventListener('scroll', () => interactionScore += 0.5);
      
      // After 30 seconds, optimize based on interaction score
      setTimeout(() => {
        if (interactionScore > 10) {
          // High engagement - prioritize premium placements
          placementContainer.classList.add('high-engagement');
          
          if (typeof gtag !== 'undefined') {
            gtag('event', 'high_engagement_placement', {
              'interaction_score': interactionScore,
              'page_type': page,
              'position': position
            });
          }
        }
      }, 30000);
    };

    trackInteractions();
  })();
</script>

<style>
  .strategic-placement {
    display: flex;
    flex-direction: column;
    gap: 20px;
    margin: 16px 0;
  }

  .placement-slot {
    position: relative;
  }

  /* AI Tool Spotlight Styles */
  .ai-tool-spotlight {
    background: rgba(26, 26, 27, 0.95);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin: 16px 0;
  }

  .spotlight-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0, 212, 255, 0.1);
  }

  .spotlight-header h3 {
    color: #fff;
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .affiliate-tag {
    background: linear-gradient(90deg, #ff6b35, #f7931e);
    color: #fff;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .featured-tools {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .tool-item {
    display: flex;
    gap: 12px;
    padding: 16px;
    background: rgba(30, 30, 31, 0.8);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .tool-item:hover {
    border-color: rgba(0, 212, 255, 0.3);
    transform: translateY(-1px);
  }

  .tool-item.premium {
    border-color: rgba(255, 107, 53, 0.3);
    background: rgba(255, 107, 53, 0.05);
  }

  .tool-item.high-value {
    border-color: rgba(247, 147, 30, 0.3);
    background: rgba(247, 147, 30, 0.05);
  }

  .tool-icon {
    font-size: 24px;
    flex-shrink: 0;
  }

  .tool-content {
    flex: 1;
  }

  .tool-content h4 {
    color: #fff;
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 4px 0;
  }

  .tool-content p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 12px;
    margin: 0 0 8px 0;
  }

  .tool-metrics {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
  }

  .commission {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
  }

  .avg-sale {
    background: rgba(0, 212, 255, 0.1);
    color: #00d4ff;
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
  }

  .tool-cta {
    background: linear-gradient(90deg, #00d4ff, #0099cc);
    color: #000;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
  }

  .tool-cta:hover {
    background: linear-gradient(90deg, #0099cc, #007399);
    transform: translateY(-1px);
  }

  /* Trending News Section */
  .trending-news-section {
    background: rgba(26, 26, 27, 0.95);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin: 16px 0;
  }

  .section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid rgba(0, 212, 255, 0.1);
  }

  .section-header h3 {
    color: #fff;
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .native-tag {
    background: rgba(0, 212, 255, 0.1);
    color: #00d4ff;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .trending-items {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .trending-item {
    display: flex;
    gap: 12px;
    padding: 12px;
    background: rgba(30, 30, 31, 0.6);
    border-radius: 8px;
    transition: all 0.3s ease;
  }

  .trending-item:hover {
    background: rgba(30, 30, 31, 0.8);
    transform: translateY(-1px);
  }

  .trending-item.sponsored {
    border: 1px solid rgba(247, 147, 30, 0.3);
    background: rgba(247, 147, 30, 0.05);
  }

  .trend-indicator {
    font-size: 16px;
    flex-shrink: 0;
  }

  .trend-content h4 {
    color: #fff;
    font-size: 13px;
    font-weight: 600;
    margin: 0 0 4px 0;
    line-height: 1.3;
  }

  .trend-content p {
    color: rgba(255, 255, 255, 0.7);
    font-size: 11px;
    margin: 0 0 4px 0;
  }

  .sponsor-label {
    color: #f7931e;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }

  /* Newsletter Monetization */
  .newsletter-monetization {
    background: rgba(26, 26, 27, 0.95);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin: 16px 0;
  }

  .newsletter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .newsletter-header h3 {
    color: #fff;
    font-size: 18px;
    font-weight: 600;
    margin: 0;
  }

  .subscriber-count {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 11px;
    font-weight: 600;
  }

  .newsletter-content p {
    color: rgba(255, 255, 255, 0.8);
    font-size: 14px;
    margin: 0 0 16px 0;
    line-height: 1.4;
  }

  .newsletter-benefits {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-bottom: 16px;
  }

  .benefit {
    color: rgba(255, 255, 255, 0.9);
    font-size: 13px;
  }

  .newsletter-form {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 16px;
  }

  .newsletter-input {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
    padding: 12px;
    border-radius: 6px;
    font-size: 14px;
  }

  .newsletter-input::placeholder {
    color: rgba(255, 255, 255, 0.5);
  }

  .newsletter-submit {
    background: linear-gradient(90deg, #00d4ff, #0099cc);
    color: #000;
    border: none;
    padding: 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .newsletter-submit:hover {
    background: linear-gradient(90deg, #0099cc, #007399);
    transform: translateY(-1px);
  }

  .newsletter-sponsors {
    text-align: center;
  }

  .sponsors-label {
    color: rgba(255, 255, 255, 0.6);
    font-size: 11px;
    display: block;
    margin-bottom: 8px;
  }

  .sponsor-logos {
    display: flex;
    justify-content: center;
    gap: 12px;
  }

  .sponsor-logo {
    color: rgba(255, 255, 255, 0.7);
    font-size: 11px;
  }

  /* Social Proof Section */
  .social-proof-section {
    background: rgba(26, 26, 27, 0.95);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 12px;
    padding: 20px;
    margin: 16px 0;
  }

  .proof-header h3 {
    color: #fff;
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 16px 0;
    text-align: center;
  }

  .proof-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 16px;
    margin-bottom: 20px;
  }

  .stat-item {
    text-align: center;
  }

  .stat-number {
    display: block;
    color: #00d4ff;
    font-size: 20px;
    font-weight: 700;
  }

  .stat-label {
    display: block;
    color: rgba(255, 255, 255, 0.7);
    font-size: 11px;
    margin-top: 4px;
  }

  .testimonials-mini {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .testimonial-item {
    background: rgba(30, 30, 31, 0.6);
    padding: 12px;
    border-radius: 8px;
    border-left: 3px solid #00d4ff;
  }

  .testimonial-item p {
    color: rgba(255, 255, 255, 0.9);
    font-size: 12px;
    margin: 0 0 6px 0;
    font-style: italic;
  }

  .testimonial-author {
    color: rgba(255, 255, 255, 0.6);
    font-size: 11px;
  }

  /* High Engagement Optimization */
  .strategic-placement.high-engagement .content-spotlight {
    border-color: rgba(0, 212, 255, 0.4);
    box-shadow: 0 8px 32px rgba(0, 212, 255, 0.15);
  }

  .strategic-placement.high-engagement .tool-cta,
  .strategic-placement.high-engagement .newsletter-submit {
    background: linear-gradient(90deg, #ff6b35, #f7931e);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.02); }
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .strategic-placement {
      gap: 16px;
    }
    
    .proof-stats {
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    .newsletter-form {
      gap: 8px;
    }
  }
</style>
