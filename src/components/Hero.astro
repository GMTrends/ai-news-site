---
import { getFeaturedArticles } from '../lib/sanity';
import { getCategoryUrl } from '../utils/urlHelpers';
import { generateHeroImage, generateThumbnail } from '../utils/imageOptimization';
import HeroPremiumAd from './HeroPremiumAd.astro';


// Fetch more than 5 to allow for filtering/prioritization
const allFeaturedArticles = await getFeaturedArticles(12);

// Helper: check if article has all tags in an array
function hasTags(article: any, tags: string[]) {
  if (!article.tags) return false;
  return tags.every(tag => article.tags.includes(tag));
}

// Helper: get articles published in the last N days
function isRecent(article: any, days: number = 30) {
  if (!article.publishedAt) return false;
  const published = new Date(article.publishedAt);
  const now = new Date();
  const diff = (now.getTime() - published.getTime()) / (1000 * 60 * 60 * 24);
  return diff <= days;
}

// Helper: sort articles by publish date descending
function sortByDateDesc(articles: any[]) {
  return articles.slice().sort((a, b) => {
    const dateA = new Date(a.publishedAt).getTime();
    const dateB = new Date(b.publishedAt).getTime();
    return dateB - dateA;
  });
}

// Enhanced: select the best article for a given hero placement, revenue potential, and content type
function selectBestByHeroFields(articles: any[], heroPlacement: string, revenuePotential?: string, contentType?: string, priorityValue?: string): any | null {
  let matches = articles.filter(a => a.heroPlacement === heroPlacement);
  if (priorityValue) matches = matches.filter(a => a.priority === priorityValue);
  if (revenuePotential) matches = matches.filter(a => a.revenuePotential === revenuePotential);
  if (contentType) matches = matches.filter(a => a.contentType === contentType);
  if (matches.length === 0) return null;
  const recent = matches.filter(a => isRecent(a, 30));
  if (recent.length > 0) {
    return sortByDateDesc(recent)[0];
  }
  return sortByDateDesc(matches)[0];
}

// MAIN HERO ARTICLE LOGIC (updated to use only heroPlacement field)
function selectMainArticle(articles: any[]): any {
  // Priority 1: High
  let main = selectBestByHeroFields(articles, 'large', 'high-affiliate', 'tool-review', 'high');
  if (main) return main;
  main = selectBestByHeroFields(articles, 'large', 'high-affiliate', undefined, 'high');
  if (main) return main;
  main = selectBestByHeroFields(articles, 'large', undefined, undefined, 'high');
  if (main) return main;

  // Priority 2: Normal
  main = selectBestByHeroFields(articles, 'large', 'high-affiliate', 'tool-review', 'normal');
  if (main) return main;
  main = selectBestByHeroFields(articles, 'large', 'high-affiliate', undefined, 'normal');
  if (main) return main;
  main = selectBestByHeroFields(articles, 'large', undefined, undefined, 'normal');
  if (main) return main;

  // Fallback: use heroPlacement === 'small' (Small Cards)
  main = articles.filter(a => a.heroPlacement === 'small')
    .sort((a, b) => new Date(b.publishedAt).getTime() - new Date(a.publishedAt).getTime())[0];
  return main;
}

// ENHANCED SMALL CARDS LOGIC
function selectSmallArticles(articles: any[], mainArticle: any): any[] {
  let pool = articles.filter((a: any) => a._id !== mainArticle?._id);

  // Try to get up to 4 with "featured-hero-small"
  let smalls = pool.filter((a: any) => hasTags(a, ['featured-hero-small']));

  // Ensure variety: try to get different content types, with recency weighting
  const typeTags = ['tool-review', 'comparison', 'tutorial', 'breaking-news'];
  let selected: any[] = [];
  let usedIds = new Set();

  for (let tag of typeTags) {
    // Prefer recent, then newest
    let candidates = smalls.filter((a: any) => hasTags(a, [tag]) && !usedIds.has(a._id));
    let best = null;
    if (candidates.length > 0) {
      const recent = candidates.filter(a => isRecent(a, 30));
      if (recent.length > 0) {
        best = sortByDateDesc(recent)[0];
      } else {
        best = sortByDateDesc(candidates)[0];
      }
    }
    if (best) {
      selected.push(best);
      usedIds.add(best._id);
    }
    if (selected.length === 4) break;
  }

  // Fill remaining slots with other "featured-hero-small" articles (recency weighted)
  if (selected.length < 4) {
    let remaining = smalls.filter((a: any) => !usedIds.has(a._id));
    // Prefer recent, then newest
    let sorted = sortByDateDesc([
      ...remaining.filter(a => isRecent(a, 30)),
      ...remaining.filter(a => !isRecent(a, 30))
    ]);
    for (let a of sorted) {
      if (!usedIds.has(a._id)) {
        selected.push(a);
        usedIds.add(a._id);
        if (selected.length === 4) break;
      }
    }
  }

  // Fallback: fill with legacy "featured" articles (recency weighted)
  if (selected.length < 4) {
    let legacy = pool.filter((a: any) => hasTags(a, ['featured']) && !usedIds.has(a._id));
    let sorted = sortByDateDesc([
      ...legacy.filter(a => isRecent(a, 30)),
      ...legacy.filter(a => !isRecent(a, 30))
    ]);
    for (let a of sorted) {
      selected.push(a);
      usedIds.add(a._id);
      if (selected.length === 4) break;
    }
  }

  // Final fallback: fill with any remaining articles (recency weighted)
  if (selected.length < 4) {
    let sorted = sortByDateDesc([
      ...pool.filter(a => isRecent(a, 30) && !usedIds.has(a._id)),
      ...pool.filter(a => !isRecent(a, 30) && !usedIds.has(a._id))
    ]);
    for (let a of sorted) {
      selected.push(a);
      usedIds.add(a._id);
      if (selected.length === 4) break;
    }
  }

  return selected;
}

// MAIN LOGIC
const mainArticle = selectMainArticle(allFeaturedArticles);
const secondaryArticles = selectSmallArticles(allFeaturedArticles, mainArticle);

// Fallback: if nothing found, use the first 5 as before
const showMain = mainArticle || allFeaturedArticles[0];
const showSecondary = secondaryArticles.length > 0 ? secondaryArticles : allFeaturedArticles.slice(1, 5);

// Helper function to format date
function formatDate(dateString: string | undefined) {
  if (!dateString) return 'Recently'
  return new Date(dateString).toLocaleDateString('en-US', { 
    year: 'numeric', 
    month: 'short', 
    day: 'numeric' 
  })
}

// Helper function to get article URL
function getArticleUrl(article: any) {
  const category = article.category?.slug?.current || 'articles'
  const slug = article.slug?.current || article.slug
  return `/${category}/${slug}`
}

// Helper to get normalized category name
function getCategoryKey(category: any) {
  if (!category) return '';
  return (category.displayName || category.name || '').toLowerCase();
}
---

<section class="hero">
	<div class="hero-container">
		<div class="hero-content">
			<div class="hero-text-group">
				<h1 class="hero-title">Master AI Before Everyone Else</h1>
				<p class="hero-subtitle">Expert AI reviews and breaking news</p>
			</div>
		</div>
		
		<div class="hero-grid">
			<!-- Main Featured Article -->
			{showMain && (
				<article class="main-featured">
					<a href={getArticleUrl(showMain)} class="article-image-main-link">
						<div class="article-image-main">
							{showMain.featuredImage ? (
								<img 
									{...generateHeroImage(showMain.featuredImage, showMain.title, 800, 400)}
									width="800"
									height="400"
								/>
							) : (
								<div class="placeholder-image-main">ðŸ¤–</div>
							)}
						</div>
					</a>
					<div class="article-content-main">
						{showMain.category ? (
							getCategoryKey(showMain.category) === 'ai business' || getCategoryKey(showMain.category) === 'business' ? (
								<a href="/categories/business" class="category-badge">BUSINESS</a>
							) : getCategoryKey(showMain.category) === 'marketing' ? (
								<a href="/categories/marketing" class="category-badge">MARKETING</a>
							) : getCategoryKey(showMain.category) === 'ai agents' ? (
								<a href="/categories/ai-agents" class="category-badge">AI AGENTS</a>
							) : getCategoryKey(showMain.category) === 'creative' ? (
								<a href="/categories/creative" class="category-badge">CREATIVE</a>
							) : getCategoryKey(showMain.category) === 'ecommerce' ? (
								<a href="/categories/ecommerce" class="category-badge">ECOMMERCE</a>
							) : getCategoryKey(showMain.category) === 'productivity' ? (
								<a href="/categories/productivity" class="category-badge">PRODUCTIVITY</a>
							) : (
								<span class="category-badge">UNCATEGORIZED</span>
							)
						) : (
							<span class="category-badge">UNCATEGORIZED</span>
						)}
						<h2><a href={getArticleUrl(showMain)}>{showMain.title}</a></h2>
						<p>{showMain.excerpt}</p>
						<div class="article-meta">
							<span class="author">
								By <a href={`/authors/${typeof showMain.author?.slug === 'object' ? showMain.author.slug.current : showMain.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${showMain.author?.name || 'Anonymous'}`}>
									{showMain.author?.name || 'Anonymous'}
								</a>
							</span>
							<span class="date">{formatDate(showMain.publishedAt)}</span>
						</div>
					</div>
				</article>
			)}

			<!-- Revenue-Optimized Sidebar -->
			<div class="hero-sidebar">
				<!-- Secondary Articles Grid with Premium Ad -->
				<div class="secondary-grid">
					<!-- Premium Ad Placement -->
					<HeroPremiumAd />
					
					{showSecondary.slice(0, 3).map((article: any) => (
						<article class="secondary-article">
							<a href={getArticleUrl(article)} class="article-image-small-link">
								<div class="article-image-small">
									{article.featuredImage ? (
										<img 
											{...generateThumbnail(article.featuredImage, article.title, 100, 100)}
											width="100"
											height="100"
										/>
									) : (
										<div class="placeholder-image-small">ðŸ“°</div>
									)}
								</div>
							</a>
							<div class="article-content-small">
								{article.category ? (
									getCategoryKey(article.category) === 'ai business' || getCategoryKey(article.category) === 'business' ? (
										<a href="/categories/business" class="category-badge">BUSINESS</a>
									) : getCategoryKey(article.category) === 'marketing' ? (
										<a href="/categories/marketing" class="category-badge">MARKETING</a>
									) : getCategoryKey(article.category) === 'ai agents' ? (
										<a href="/categories/ai-agents" class="category-badge">AI AGENTS</a>
									) : getCategoryKey(article.category) === 'creative' ? (
										<a href="/categories/creative" class="category-badge">CREATIVE</a>
									) : getCategoryKey(article.category) === 'ecommerce' ? (
										<a href="/categories/ecommerce" class="category-badge">ECOMMERCE</a>
									) : getCategoryKey(article.category) === 'productivity' ? (
										<a href="/categories/productivity" class="category-badge">PRODUCTIVITY</a>
									) : (
										<span class="category-badge">UNCATEGORIZED</span>
									)
								) : (
									<span class="category-badge">UNCATEGORIZED</span>
								)}
								<div style="height: 6px;"></div>
								<h3><a href={getArticleUrl(article)}>{article.title}</a></h3>
								<div class="article-meta-small">
									<span class="author">
										By <a href={`/authors/${typeof article.author?.slug === 'object' ? article.author.slug.current : article.author?.slug || 'anonymous'}`} class="author-link" aria-label={`View profile of ${article.author?.name || 'Anonymous'}`}>
											{article.author?.name || 'Anonymous'}
										</a>
									</span>
									<span class="date">{formatDate(article.publishedAt)}</span>
								</div>
							</div>
						</article>
					))}
				</div>
			</div>
		</div>
	</div>
</section>

<style>
	/* Critical CSS for hero section - inlined for faster rendering */
	:root {
		--gradient-primary: linear-gradient(135deg, #00d4ff 0%, #0066ff 100%);
		--gradient-bg: linear-gradient(135deg, rgba(0, 212, 255, 0.05) 0%, rgba(0, 102, 255, 0.05) 100%);
		--gradient-placeholder: linear-gradient(135deg, rgba(0, 212, 255, 0.2) 0%, rgba(0, 102, 255, 0.2) 100%);
		--color-text: #ffffff;
		--color-text-secondary: #b3b3b3;
		--color-bg: #1a1a1b;
		--border-color: rgba(255, 255, 255, 0.1);
	}

	section.hero {
		background: var(--gradient-bg) !important;
		padding: 2rem 0 3rem 0 !important;
		margin-top: 2rem !important;
		position: relative !important;
		overflow: hidden !important;
		top: 0 !important;
	}

	.hero::before {
		content: '';
		position: absolute;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: 
			radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.12) 0%, transparent 50%),
			radial-gradient(circle at 80% 20%, rgba(0, 102, 255, 0.12) 0%, transparent 50%),
			radial-gradient(circle at 40% 80%, rgba(0, 212, 255, 0.08) 0%, transparent 50%);
		animation: float 20s ease-in-out infinite;
		pointer-events: none;
		z-index: 0;
		/* Performance optimizations */
		will-change: transform;
		transform: translateZ(0);
		transform-origin: center center;
	}

	section.hero .hero-container {
		max-width: 1400px !important;
		margin: 0 auto !important;
		padding: 2rem 2rem 0 2rem !important;
		position: relative !important;
		z-index: 1 !important;
		width: 100% !important;
		max-width: min(1400px, calc(100vw - 4rem)) !important;
		box-sizing: border-box !important;
		/* FIXED: Prevent left-shifting and ensure centering */
		left: auto !important;
		right: auto !important;
		transform: none !important;
		margin-top: 0 !important;
	}

	section.hero .hero-content {
		text-align: center;
		padding: 0;
	}

	section.hero .hero-text-group {
		text-align: center !important;
		margin: 0 auto !important;
		width: 100% !important;
		max-width: 800px !important;
		padding: 1rem 0 !important;
	}

	.hero-title {
		font-size: 2.2rem;
		font-weight: 700;
		margin: 0 auto !important;
		padding: 0 !important;
		line-height: 1.1 !important;
		color: #ffffff !important;
		text-align: center !important;
		position: relative;
		z-index: 10;
		display: block;
		visibility: visible;
		opacity: 1;
		width: 100%;
	}

	.hero-subtitle {
		font-size: 1rem;
		color: #b3b3b3 !important;
		max-width: 500px;
		margin: 0 auto !important;
		padding: 0 !important;
		margin-top: 0.5rem !important;
		line-height: 1.4 !important;
		text-align: center !important;
		position: relative;
		z-index: 10;
		display: block;
		visibility: visible;
		opacity: 1;
		width: 100%;
	}

	.hero-grid {
		display: grid;
		grid-template-columns: 2fr 1fr;
		gap: 1.2rem;
		margin-top: 0.5rem;
	}

	/* Common styles for articles */
	.main-featured,
	.secondary-article {
		background: var(--color-bg);
		backdrop-filter: blur(10px);
		border: 1px solid var(--border-color);
		border-radius: 16px;
		transition: transform 0.3s ease, box-shadow 0.3s ease;
	}

	.main-featured {
		padding: 1.5rem;
	}

	/* Hover effects only for non-touch devices */
	@media (hover: hover) and (pointer: fine) {
		.main-featured:hover {
			transform: translateY(-4px);
			box-shadow: 0 15px 30px rgba(0, 212, 255, 0.15);
			border-color: rgba(0, 212, 255, 0.3);
		}

		.article-image-main-link:hover img {
			transform: scale(1.05);
		}

		.article-content-main h2 a:hover {
			background: var(--gradient-primary);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			transform: translateX(2px);
		}

		.secondary-article:hover {
			transform: translateX(4px);
			box-shadow: 0 8px 25px rgba(0, 212, 255, 0.15);
			border-color: rgba(0, 212, 255, 0.3);
		}

		.article-content-small h3 a:hover {
			background: var(--gradient-primary);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
			transform: translateX(2px);
		}

		.category-badge:hover {
			transform: translateY(-2px);
			box-shadow: 0 6px 16px rgba(0, 212, 255, 0.4);
			background: rgba(0, 212, 255, 0.3);
			color: #ffffff;
		}

		.author-link:hover {
			color: #00d4ff;
			text-decoration: none;
			transform: translateY(-1px);
		}
	}

	.article-image-main {
		width: 100%;
		aspect-ratio: 2/1;
		margin-bottom: 1.5rem;
		border-radius: 12px;
		overflow: hidden;
	}

	.article-image-main-link {
		display: block;
		text-decoration: none;
		color: inherit;
		cursor: pointer;
	}

	.article-image-main img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform 0.3s ease;
	}

	.placeholder-image-main {
		width: 100%;
		height: 100%;
		background: var(--gradient-placeholder);
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 4rem;
		border-radius: 12px;
	}

	.article-content-main {
		padding: 0;
	}

	.article-content-main h2 {
		font-size: 1.8rem;
		margin: 1rem 0;
		line-height: 1.2;
	}

	.article-content-main h2 a {
		color: var(--color-text);
		text-decoration: none;
		transition: all 0.3s ease;
		outline: none;
	}

	.article-content-main p {
		color: var(--color-text-secondary);
		line-height: 1.6;
		margin-bottom: 1.5rem;
		font-size: 1rem;
	}

	/* Secondary Articles Grid */
	.hero-sidebar {
		display: flex;
		flex-direction: column;
		gap: 0;
	}
	
	.secondary-grid {
		display: flex;
		flex-direction: column;
		gap: 1.3rem;
	}
	

	.secondary-article {
		padding: 1.2rem;
		display: flex;
		gap: 1.2rem;
		align-items: center;
	}

	.article-image-small {
		width: 100px;
		height: 100px;
		border-radius: 8px;
		overflow: hidden;
		flex-shrink: 0;
	}

	.article-image-small-link {
		display: block;
		text-decoration: none;
		color: inherit;
		cursor: pointer;
		flex-shrink: 0;
	}

	.article-image-small img {
		width: 100%;
		height: 100%;
		object-fit: cover;
	}

	.placeholder-image-small {
		width: 100%;
		height: 100%;
		background: var(--gradient-placeholder);
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 1.5rem;
		border-radius: 8px;
	}

	.article-content-small h3 {
		font-size: 1rem;
		margin: 0.25rem 0 0.25rem 0;
		line-height: 1.3;
	}

	.article-content-small h3 a {
		color: var(--color-text);
		text-decoration: none;
		transition: all 0.3s ease;
		outline: none;
	}

	/* Common meta styles */
	.article-meta,
	.article-meta-small {
		color: var(--color-text-secondary);
		font-size: 0.9rem;
		display: flex;
		gap: 1rem;
		align-items: center;
	}

	.article-meta .author,
	.article-meta .date,
	.article-meta-small .author,
	.article-meta-small .date {
		display: inline-flex;
		align-items: center;
		line-height: 1;
	}

	.category-badge {
		background: rgba(0, 212, 255, 0.2);
		color: #00d4ff;
		padding: 0.2rem 0.5rem;
		border-radius: 12px;
		font-size: 0.65rem;
		font-weight: 600;
		text-transform: uppercase;
		letter-spacing: 0.5px;
		transition: all 0.3s ease;
		text-decoration: none;
		display: inline-block;
	}

	/* Author link styles */
	.author-link {
		color: var(--color-text-secondary);
		text-decoration: none;
		transition: all 0.3s ease;
		border-radius: 4px;
		padding: 2px 4px;
		margin: -2px -4px;
	}

	.author-link:focus {
		outline: 2px solid #00d4ff;
		outline-offset: 2px;
		background: rgba(0, 212, 255, 0.1);
	}

	/* Ensure author text maintains proper spacing */
	.author {
		display: inline-flex;
		align-items: center;
		gap: 0.25rem;
	}

	/* Responsive design */
	@media (max-width: 768px) {
		.hero-grid {
			grid-template-columns: 1fr;
			gap: 0.7rem;
			margin-top: 0.7rem;
		}

		.hero-title {
			font-size: 1.5rem;
		}

		.hero-content {
			margin-bottom: 0.7rem;
		}
		
		.hero {
			padding: 1rem 0 1.3rem 0;
		}
		
		/* Maintain 2:1 aspect ratio on mobile */
		.article-image-main {
			aspect-ratio: 2/1;
		}

		.article-content-main h2 {
			font-size: 1.4rem;
			line-height: 1.3;
		}
		
		.article-content-main p {
			font-size: 0.9rem;
			line-height: 1.5;
		}
		
		.main-featured {
			padding: 1rem;
		}

		.secondary-article {
			padding: 0.9rem;
			gap: 0.9rem;
		}

		.article-image-small {
			width: 75px;
			height: 75px;
		}
		
		.article-content-small h3 {
			font-size: 0.9rem;
			line-height: 1.3;
		}
		
		.article-meta,
		.article-meta-small {
			font-size: 0.8rem;
			flex-direction: column;
			gap: 0.25rem;
			align-items: flex-start;
		}
		

		.hero-sidebar {
			gap: 0;
		}
	}

	@media (max-width: 480px) {
		.hero-title {
			font-size: 1.1rem;
		}
		
		.hero-content {
			margin-bottom: 0.5rem;
		}
		
		.hero {
			padding: 0.7rem 0 1rem 0;
		}
		
		.hero-grid {
			gap: 0.4rem;
			margin-top: 0.4rem;
		}
		
		/* Maintain 2:1 aspect ratio on small mobile */
		.article-image-main {
			aspect-ratio: 2/1;
		}
		
		.article-content-main h2 {
			font-size: 1.2rem;
		}
		

		.hero-sidebar {
			gap: 0;
		}
		
		.article-content-main p {
			font-size: 0.85rem;
		}
		
		.secondary-article {
			padding: 0.7rem;
			gap: 0.7rem;
		}
		
		.article-image-small {
			width: 65px;
			height: 65px;
		}
		
		.article-content-small h3 {
			font-size: 0.85rem;
		}
		
		.category-badge {
			font-size: 0.7rem;
			padding: 0.35rem 0.75rem;
		}
	}

	@keyframes float {
		0%, 100% { 
			transform: translateY(0px) rotate(0deg) translateZ(0); 
		}
		50% { 
			transform: translateY(-10px) rotate(90deg) translateZ(0); 
		}
	}
</style>