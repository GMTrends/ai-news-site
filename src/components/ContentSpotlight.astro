---
/**
 * ContentSpotlight - Strategic content placement component
 * Designed for maximum revenue while avoiding ad-blocker detection
 */

import { adManager, AdBlockerEvasion, RevenueTracker } from '../lib/ad-manager.ts';

interface Props {
  slotId: string;
  position?: 'hero-sidebar' | 'article-top' | 'article-middle' | 'article-bottom' | 'category-sidebar' | 'footer-banner' | 'homepage-leaderboard';
  customTargeting?: string[];
  className?: string;
  priority?: 'premium' | 'high' | 'medium' | 'low';
}

const { 
  slotId,
  position = 'hero-sidebar',
  customTargeting = [],
  className = '',
  priority = 'high'
} = Astro.props;

// Get ad slot configuration
const adSlot = adManager.getAdSlot(slotId);
if (!adSlot) {
  console.warn(`Ad slot ${slotId} not found`);
}

// Generate ad-blocker evasion elements
const containerId = AdBlockerEvasion.generateElementId();
const containerClass = AdBlockerEvasion.generateClassName();
const safeTerms = AdBlockerEvasion.getSafeTerms();

// Merge targeting keywords
const targeting = [...(adSlot?.targeting || []), ...customTargeting];
const targetingString = targeting.join(',');

// Revenue optimization based on position and priority
const revenueMultiplier = {
  'premium': 1.5,
  'high': 1.2,
  'medium': 1.0,
  'low': 0.8
}[priority] || 1.0;

const positionMultiplier = {
  'hero-sidebar': 1.4,
  'article-top': 1.3,
  'article-middle': 1.1,
  'category-sidebar': 1.2,
  'article-bottom': 0.9,
  'footer-banner': 1.0,
  'homepage-leaderboard': 1.5
}[position] || 1.0;

const estimatedCPM = Math.round(15 * revenueMultiplier * positionMultiplier);
---

<div 
  class={`content-spotlight ${containerClass} ${className}`}
  id={containerId}
  data-slot={slotId}
  data-position={position}
  data-targeting={targetingString}
  data-priority={priority}
>
  <!-- Partner Content Label (Ad-blocker friendly) -->
  <div class="partner-label">
    <span class="label-text">{safeTerms.sponsored}</span>
    <span class="revenue-indicator">Premium</span>
  </div>

  <!-- High-Revenue Content Area -->
  <div class="spotlight-content" data-size={adSlot?.size || '300x250'}>
    
    <!-- PLACEHOLDER FOR HIGH-CPM CONTENT -->
    <div class="premium-showcase">
      <div class="showcase-visual">
        <div class="ai-badge">ðŸš€</div>
        <div class="premium-tag">FEATURED</div>
      </div>
      <div class="showcase-content">
        <h4 class="showcase-title">{adSlot?.name || 'Premium AI Solutions'}</h4>
        <p class="showcase-description">Discover cutting-edge tools that drive business growth</p>
        <div class="showcase-metrics">
          <span class="cpm-indicator">CPM: ${estimatedCPM}+</span>
          <span class="performance-tag">High Converting</span>
        </div>
        <button class="showcase-cta">Explore Solutions â†’</button>
      </div>
    </div>

    <!-- REVENUE-OPTIMIZED INTEGRATION SCRIPTS -->
    <script define:vars={{ containerId, slotId, targetingString, priority, estimatedCPM }}>
      (function() {
        const container = document.getElementById(containerId);
        if (!container) return;

        // Track impression for revenue analytics
        const trackImpression = () => {
          if (typeof RevenueTracker !== 'undefined') {
            RevenueTracker.trackImpression(slotId);
          }
          
          // Send analytics data
          if (typeof gtag !== 'undefined') {
            gtag('event', 'content_view', {
              'custom_parameter_1': slotId,
              'custom_parameter_2': priority,
              'value': estimatedCPM
            });
          }
        };

        // Intersection Observer for viewability tracking
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting && entry.intersectionRatio > 0.5) {
              trackImpression();
              observer.unobserve(entry.target);
            }
          });
        }, { threshold: 0.5 });

        observer.observe(container);

        // Click tracking for revenue optimization
        container.addEventListener('click', (e) => {
          if (e.target.closest('.showcase-cta')) {
            if (typeof RevenueTracker !== 'undefined') {
              RevenueTracker.trackClick(slotId, estimatedCPM * 0.01);
            }
            
            // Enhanced click tracking
            if (typeof gtag !== 'undefined') {
              gtag('event', 'content_click', {
                'custom_parameter_1': slotId,
                'custom_parameter_2': 'cta_click',
                'value': estimatedCPM
              });
            }
          }
        });

        // A/B Testing Integration
        const runABTest = () => {
          const testVariant = Math.random() > 0.5 ? 'A' : 'B';
          container.setAttribute('data-test-variant', testVariant);
          
          if (testVariant === 'B') {
            // Test variant with different styling
            const showcase = container.querySelector('.premium-showcase');
            if (showcase) {
              showcase.style.background = 'linear-gradient(135deg, #1a1a1b 0%, #2d2d30 100%)';
              showcase.style.border = '2px solid #00d4ff';
            }
          }
        };

        runABTest();

        // Real Ad Integration (Google AdSense, Media.net, etc.)
        const loadRealContent = () => {
          // Google AdSense Integration
          if (window.adsbygoogle) {
            const adElement = document.createElement('ins');
            adElement.className = 'adsbygoogle';
            adElement.style.display = 'block';
            adElement.setAttribute('data-ad-client', 'ca-pub-YOUR-ADSENSE-ID');
            adElement.setAttribute('data-ad-slot', 'YOUR-SLOT-ID');
            adElement.setAttribute('data-ad-format', 'rectangle');
            adElement.setAttribute('data-full-width-responsive', 'false');
            
            // High-value targeting
            adElement.setAttribute('data-ad-targeting', targetingString);
            
            // Size configuration
            if (container.dataset.size === '300x250') {
              adElement.style.width = '300px';
              adElement.style.height = '250px';
            }
            
            container.appendChild(adElement);
            (window.adsbygoogle = window.adsbygoogle || []).push({});
          }

          // Media.net Integration for higher CPMs
          if (window._mNHandle) {
            window._mNHandle.queue.push(() => {
              window._mNDetails.loadTag("YOUR-MEDIA-NET-ID", container.id, {
                targeting: targetingString.split(','),
                size: container.dataset.size || '300x250'
              });
            });
          }
        };

        // Load real ads after a short delay to ensure proper initialization
        setTimeout(loadRealContent, 1000);
      })();
    </script>
  </div>

  <!-- Performance Analytics -->
  <div class="analytics-tracker" style="display: none;">
    <span data-slot={slotId}></span>
    <span data-cpm={estimatedCPM}></span>
    <span data-targeting={targetingString}></span>
  </div>
</div>

<style>
  .content-spotlight {
    background: rgba(26, 26, 27, 0.95);
    border: 1px solid rgba(0, 212, 255, 0.15);
    border-radius: 12px;
    padding: 16px;
    margin: 16px 0;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .content-spotlight:hover {
    border-color: rgba(0, 212, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 212, 255, 0.1);
    transform: translateY(-2px);
  }

  .partner-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(0, 212, 255, 0.1);
  }

  .label-text {
    font-size: 11px;
    color: rgba(255, 255, 255, 0.6);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-weight: 500;
  }

  .revenue-indicator {
    background: linear-gradient(90deg, #00d4ff, #0099cc);
    color: #000;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
  }

  .spotlight-content {
    position: relative;
  }

  .premium-showcase {
    background: linear-gradient(135deg, #1e1e1f 0%, #2a2a2d 100%);
    border: 1px solid rgba(0, 212, 255, 0.2);
    border-radius: 8px;
    padding: 16px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .premium-showcase:hover {
    background: linear-gradient(135deg, #252526 0%, #2f2f32 100%);
    border-color: rgba(0, 212, 255, 0.4);
  }

  .showcase-visual {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .ai-badge {
    font-size: 24px;
    filter: drop-shadow(0 0 8px rgba(0, 212, 255, 0.3));
  }

  .premium-tag {
    background: linear-gradient(90deg, #ff6b35, #f7931e);
    color: #fff;
    padding: 4px 10px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .showcase-title {
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    margin: 0 0 8px 0;
    line-height: 1.3;
  }

  .showcase-description {
    color: rgba(255, 255, 255, 0.8);
    font-size: 13px;
    line-height: 1.4;
    margin: 0 0 12px 0;
  }

  .showcase-metrics {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
  }

  .cpm-indicator {
    background: rgba(0, 212, 255, 0.1);
    color: #00d4ff;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
  }

  .performance-tag {
    background: rgba(34, 197, 94, 0.1);
    color: #22c55e;
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
  }

  .showcase-cta {
    background: linear-gradient(90deg, #00d4ff, #0099cc);
    color: #000;
    border: none;
    padding: 10px 20px;
    border-radius: 6px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
  }

  .showcase-cta:hover {
    background: linear-gradient(90deg, #0099cc, #007399);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .content-spotlight {
      margin: 12px 0;
      padding: 12px;
    }

    .showcase-title {
      font-size: 14px;
    }

    .showcase-description {
      font-size: 12px;
    }

    .showcase-metrics {
      flex-direction: column;
      gap: 6px;
    }
  }

  /* A/B Test Variant Styles */
  .content-spotlight[data-test-variant="B"] .premium-showcase {
    background: linear-gradient(135deg, #1a1a1b 0%, #2d2d30 100%);
    border: 2px solid #00d4ff;
  }

  .content-spotlight[data-test-variant="B"] .showcase-cta {
    background: linear-gradient(90deg, #ff6b35, #f7931e);
  }
</style>
